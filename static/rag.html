<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TTRPG Center – RAG</title>

    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/site.webmanifest">
    <meta name="theme-color" content="#8B0000">

    <style>
      body { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0b0e11; color:#d9e0ee; margin:0; }
      header { padding: 12px 16px; background:#11161c; border-bottom:1px solid #2a3340; }
      main { padding:16px; max-width: 980px; margin: 0 auto; }
      .row { display:flex; gap:8px; align-items:center; }
      input[type=text] { flex:1; padding:10px; border:1px solid #2a3340; background:#0f1318; color:#d9e0ee; border-radius:6px; }
      button { padding:10px 14px; background:#2a7bff; border:0; color:white; border-radius:6px; cursor:pointer; }
      button:disabled { background:#3a4a63; cursor:default; }
      .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:16px; }
      pre, code { white-space: pre-wrap; word-break: break-word; }
      .card { border:1px solid #2a3340; border-radius:8px; padding:12px; background:#0f1318; }
      .muted { color:#8a98b2; }
      .small { font-size: 12px; }
      ul { padding-left: 18px; }
    </style>
  </head>
  <body>
    <header>
      <strong>TTRPG Center</strong> · Phase 2 RAG Demo
    </header>
    <main>
      <div class="row">
        <input id="q" type="text" placeholder="Ask about rules, feats, spells…" />
        <button id="ask">Ask</button>
      </div>
      <div id="status" class="muted small" style="margin-top:8px;"></div>

      <div class="grid">
        <div class="card">
          <h3>Answer</h3>
          <div id="answer" class="muted"></div>
          <div id="citations" class="small" style="margin-top:8px;"></div>
        </div>
        <div class="card">
          <h3>Details</h3>
          <div id="details"></div>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>Retrieved Chunks</h3>
        <div id="retrieved"></div>
      </div>
    </main>

    <script>
      const q = document.getElementById('q');
      const askBtn = document.getElementById('ask');
      const statusEl = document.getElementById('status');
      const answerEl = document.getElementById('answer');
      const detailsEl = document.getElementById('details');
      const retrievedEl = document.getElementById('retrieved');
      const citationsEl = document.getElementById('citations');

      function esc(s){ return (s||'').toString().replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

      async function ask(){
        const query = q.value.trim();
        if(!query) return;
        askBtn.disabled = true; statusEl.textContent = 'Asking…';
        answerEl.textContent = ''; detailsEl.textContent = ''; retrievedEl.textContent = ''; citationsEl.textContent='';
        try{
          const r = await fetch('/rag/ask', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({query}) });
          const data = await r.json();
          statusEl.textContent = `Intent=${data.classification.intent} · Domain=${data.classification.domain} · ${data.metrics.timer_ms}ms · ${data.model.model}`;
          answerEl.textContent = (data.answers && data.answers.selected === 'openai' ? data.answers.openai : data.answers.claude) || '(no answer)';
          const cites = (data.retrieved||[]).slice(0,3).map(c=>`- ${esc(c.source)} ${(c.metadata && (c.metadata.section||c.metadata.section_title))?('· '+esc(c.metadata.section||c.metadata.section_title)) : ''}`).join('\n');
          citationsEl.innerHTML = `<pre>${cites}</pre>`;
          detailsEl.innerHTML = `<pre>${esc(JSON.stringify({ classification:data.classification, plan:data.plan, model:data.model }, null, 2))}</pre>`;
          retrievedEl.innerHTML = (data.retrieved||[]).map(c=>`<div class="small" style="margin-bottom:10px;"><div class="muted">${esc(c.id)} · score=${c.score.toFixed(3)}</div><div><pre>${esc(c.text)}</pre></div></div>`).join('');
        }catch(e){
          statusEl.textContent = 'Error: '+e;
        }finally{
          askBtn.disabled = false;
        }
      }
      askBtn.addEventListener('click', ask);
      q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ ask(); }});
    </script>
  </body>
  </html>

