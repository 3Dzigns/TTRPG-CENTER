{% extends "base.html" %}

{% block title %}Dictionary Management - TTRPG Center Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">Dictionary Management</h1>
        <div class="mt-1">
            <span class="text-muted small me-3">
                <i class="bi bi-database me-1"></i>
                Backend:
                <span id="dict-backend-status" class="badge bg-success">MongoDB</span>
            </span>
            <span class="text-muted small me-3" id="dict-connection-status">
                <i class="bi bi-wifi me-1"></i>
                <span class="badge bg-secondary">Checking...</span>
            </span>
        </div>
    </div>
    <div class="btn-group" role="group">
        <button class="btn btn-admin" onclick="addNewTerm()">
            <i class="bi bi-plus-circle me-1"></i>Add Term
        </button>
        <button class="btn btn-outline-primary" onclick="refreshDictionary()">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
        </button>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-download me-1"></i>Export
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="exportDictionary('json')">Export as JSON</a></li>
                <li><a class="dropdown-item" href="#" onclick="exportDictionary('csv')">Export as CSV</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="importDictionary()">Import Terms</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="dictTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="terms-tab" data-bs-toggle="tab" data-bs-target="#terms-pane" type="button" role="tab">
            <i class="bi bi-book me-1"></i>Dictionary Terms
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="artifacts-tab" data-bs-toggle="tab" data-bs-target="#artifacts-pane" type="button" role="tab">
            <i class="bi bi-archive me-1"></i>Artifacts
        </button>
    </li>
</ul>

<div class="tab-content" id="dictTabContent">
    <!-- Dictionary Terms Tab -->
    <div class="tab-pane fade show active" id="terms-pane" role="tabpanel">

<!-- Dictionary Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="metric-value text-primary" id="total-terms">--</div>
                <div class="metric-label">Total Terms</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="metric-value text-success" id="verified-terms">--</div>
                <div class="metric-label">Verified Terms</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="metric-value text-warning" id="pending-terms">--</div>
                <div class="metric-label">Pending Review</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="metric-value text-info" id="categories">--</div>
                <div class="metric-label">Categories</div>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="search-terms" placeholder="Search terms..." onkeyup="filterTerms()">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="category-filter" onchange="filterTerms()">
                    <option value="">All Categories</option>
                    <option value="spell">Spells</option>
                    <option value="item">Items</option>
                    <option value="creature">Creatures</option>
                    <option value="location">Locations</option>
                    <option value="rule">Rules</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="status-filter" onchange="filterTerms()">
                    <option value="">All Status</option>
                    <option value="verified">Verified</option>
                    <option value="pending">Pending Review</option>
                    <option value="draft">Draft</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Dictionary Terms Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-book me-2"></i>Dictionary Terms</h5>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" onclick="selectAllTerms()" id="select-all-btn">
                <i class="bi bi-check-square me-1"></i>Select All
            </button>
            <button class="btn btn-outline-danger" onclick="deleteSelectedTerms()" id="delete-selected-btn" style="display: none;">
                <i class="bi bi-trash me-1"></i>Delete Selected
            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="terms-empty" class="text-center text-muted py-4" style="display:none;">
            <i class="bi bi-book display-4 mb-2"></i>
            <p>No dictionary terms found.</p>
            <small>Add new terms to build your TTRPG dictionary.</small>
        </div>

        <div class="table-responsive">
            <table class="table table-sm" id="terms-table">
                <thead>
                    <tr>
                        <th style="width: 20px;">
                            <input type="checkbox" id="select-all-checkbox" onchange="toggleAllTerms(this.checked)">
                        </th>
                        <th>Term</th>
                        <th style="width: 120px;">Category</th>
                        <th style="width: 100px;">Status</th>
                        <th style="width: 100px;">Usage Count</th>
                        <th style="width: 150px;">Last Updated</th>
                        <th style="width: 120px;">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted small" id="pagination-info">
                Showing 0-0 of 0 terms
            </div>
            <nav>
                <ul class="pagination pagination-sm mb-0" id="pagination-controls">
                    <!-- Pagination will be dynamically generated -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Add/Edit Term Modal -->
<div class="modal fade" id="termModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termModalTitle">Add New Term</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="termForm">
                    <input type="hidden" id="termId" value="">

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="termName" class="form-label">Term Name *</label>
                            <input type="text" class="form-control" id="termName" required>
                        </div>
                        <div class="col-md-4">
                            <label for="termCategory" class="form-label">Category *</label>
                            <select class="form-select" id="termCategory" required>
                                <option value="">Select Category</option>
                                <option value="spell">Spell</option>
                                <option value="item">Item</option>
                                <option value="creature">Creature</option>
                                <option value="location">Location</option>
                                <option value="rule">Rule</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="termDefinition" class="form-label">Definition *</label>
                        <textarea class="form-control" id="termDefinition" rows="4" required></textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="termSource" class="form-label">Source</label>
                            <input type="text" class="form-control" id="termSource" placeholder="e.g., Player's Handbook">
                        </div>
                        <div class="col-md-6">
                            <label for="termPage" class="form-label">Page Reference</label>
                            <input type="text" class="form-control" id="termPage" placeholder="e.g., p. 123">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="termTags" class="form-label">Tags</label>
                        <input type="text" class="form-control" id="termTags" placeholder="Comma-separated tags">
                        <div class="form-text">Use tags to help with searching and organization</div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="termStatus" class="form-label">Status</label>
                            <select class="form-select" id="termStatus">
                                <option value="draft">Draft</option>
                                <option value="pending">Pending Review</option>
                                <option value="verified">Verified</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="termIsPublic">
                                <label class="form-check-label" for="termIsPublic">
                                    Make publicly visible
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-admin" onclick="saveTerm()">Save Term</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Dictionary Terms</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="importFile" class="form-label">Select File</label>
                    <input type="file" class="form-control" id="importFile" accept=".json,.csv">
                    <div class="form-text">Supported formats: JSON, CSV</div>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="overwriteExisting">
                    <label class="form-check-label" for="overwriteExisting">
                        Overwrite existing terms with same name
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-admin" onclick="performImport()">Import</button>
            </div>
        </div>
    </div>
</div>

    </div> <!-- End Dictionary Terms Tab -->

    <!-- Artifacts Tab -->
    <div class="tab-pane fade" id="artifacts-pane" role="tabpanel">
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filter Artifacts</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="artifact-env-filter" class="form-label">Environment</label>
                                <select class="form-select" id="artifact-env-filter" onchange="refreshArtifacts()">
                                    <option value="all">All Environments</option>
                                    <option value="dev">Development</option>
                                    <option value="test">Testing</option>
                                    <option value="prod">Production</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="artifact-source-filter" class="form-label">Source</label>
                                <input type="text" class="form-control" id="artifact-source-filter" placeholder="Filter by source..." onkeyup="filterArtifacts()">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="artifact-entry-filter" class="form-label">Dictionary Entry</label>
                                <input type="text" class="form-control" id="artifact-entry-filter" placeholder="Filter by entry..." onkeyup="filterArtifacts()">
                            </div>
                            <div class="col-md-6">
                                <label for="artifact-type-filter" class="form-label">Artifact Type</label>
                                <select class="form-select" id="artifact-type-filter" onchange="filterArtifacts()">
                                    <option value="all">All Types</option>
                                    <option value="json">JSON</option>
                                    <option value="text">Text</option>
                                    <option value="log">Log</option>
                                    <option value="metadata">Metadata</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Artifacts Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="metric-value text-primary" id="total-artifacts">--</div>
                                <div class="metric-label">Total Artifacts</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-value text-success" id="total-artifact-size">--</div>
                                <div class="metric-label">Total Size</div>
                            </div>
                        </div>
                        <div class="row text-center mt-3">
                            <div class="col-6">
                                <div class="metric-value text-info" id="linked-artifacts">--</div>
                                <div class="metric-label">Linked to Entries</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-value text-warning" id="orphaned-artifacts">--</div>
                                <div class="metric-label">Orphaned</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Artifacts Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-archive me-2"></i>Artifacts</h5>
                <div class="btn-group">
                    <button class="btn btn-outline-primary" onclick="refreshArtifacts()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportArtifacts()">
                        <i class="bi bi-download me-1"></i>Export All
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-sm" id="artifacts-table">
                        <thead>
                            <tr>
                                <th>Artifact Name</th>
                                <th>Source/Book</th>
                                <th>Dictionary Entry</th>
                                <th>Chunk/Page</th>
                                <th>Type</th>
                                <th>Size</th>
                                <th>Environment</th>
                                <th>Modified</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="artifacts-table-body">
                            <tr>
                                <td colspan="9" class="text-center text-muted">
                                    <div class="loading-spinner"></div>
                                    Loading artifacts...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div> <!-- End Artifacts Tab -->

</div> <!-- End Tab Content -->

<style>
.metric-value {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
}

.metric-label {
    color: var(--admin-secondary);
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.table th {
    border-top: none;
    font-weight: 600;
    background: rgba(248, 250, 252, 0.8);
}

.status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-weight: 500;
}

.status-verified { background: #dcfce7; color: #166534; }
.status-pending { background: #fef3c7; color: #92400e; }
.status-draft { background: #f1f5f9; color: #475569; }

.category-spell { color: #7c3aed; }
.category-item { color: #059669; }
.category-creature { color: #dc2626; }
.category-location { color: #2563eb; }
.category-rule { color: #d97706; }
.category-other { color: #64748b; }
</style>

{% endblock %}

{% block extra_scripts %}
<script>
let currentPage = 1;
let totalPages = 1;
let selectedTerms = new Set();
let allTerms = [];
let filteredTerms = [];

// Initialize dictionary management
document.addEventListener('DOMContentLoaded', function() {
    refreshDictionary();
    checkBackendStatus();
});

async function refreshDictionary() {
    AdminUtils.showToast('Refreshing dictionary...', 'info');
    await Promise.all([
        loadDictionaryStats(),
        loadDictionaryTerms(),
        checkBackendStatus()
    ]);
    AdminUtils.showToast('Dictionary refreshed', 'success');
}

async function checkBackendStatus() {
    const statusElement = document.getElementById('dict-connection-status');

    try {
        // Check MongoDB connection status
        const response = await fetch('/api/admin/mongodb/health');

        if (response.ok) {
            const data = await response.json();

            if (data.status === 'healthy') {
                statusElement.innerHTML = `
                    <i class="bi bi-wifi me-1"></i>
                    <span class="badge bg-success">Connected</span>
                `;
            } else {
                statusElement.innerHTML = `
                    <i class="bi bi-wifi-off me-1"></i>
                    <span class="badge bg-warning">Degraded</span>
                `;
            }

            // Update backend status indicator
            const backendElement = document.getElementById('dict-backend-status');
            if (backendElement && data.backend_active) {
                backendElement.className = 'badge bg-success';
                backendElement.textContent = 'MongoDB';
            }

        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

    } catch (error) {
        console.error('MongoDB health check failed:', error);

        // Show connection error
        statusElement.innerHTML = `
            <i class="bi bi-wifi-off me-1"></i>
            <span class="badge bg-danger">Error</span>
        `;

        // Update backend status to show error
        const backendElement = document.getElementById('dict-backend-status');
        if (backendElement) {
            backendElement.className = 'badge bg-danger';
            backendElement.textContent = 'MongoDB Error';
        }
    }
}

async function loadDictionaryStats() {
    try {
        // Mock data for now - replace with actual API call
        const stats = {
            total_terms: 1247,
            verified_terms: 892,
            pending_terms: 234,
            categories: 6
        };

        document.getElementById('total-terms').textContent = stats.total_terms.toLocaleString();
        document.getElementById('verified-terms').textContent = stats.verified_terms.toLocaleString();
        document.getElementById('pending-terms').textContent = stats.pending_terms.toLocaleString();
        document.getElementById('categories').textContent = stats.categories.toLocaleString();

    } catch (error) {
        console.error('Failed to load dictionary stats:', error);
        AdminUtils.showToast('Failed to load statistics', 'danger');
    }
}

async function loadDictionaryTerms() {
    try {
        // Mock data for now - replace with actual API call
        allTerms = generateMockTerms();
        filteredTerms = [...allTerms];
        updateTermsDisplay();

    } catch (error) {
        console.error('Failed to load dictionary terms:', error);
        AdminUtils.showToast('Failed to load dictionary terms', 'danger');
    }
}

function generateMockTerms() {
    // Generate some mock terms for demonstration
    const categories = ['spell', 'item', 'creature', 'location', 'rule', 'other'];
    const statuses = ['verified', 'pending', 'draft'];
    const terms = [];

    const sampleTerms = [
        { name: 'Fireball', category: 'spell', definition: 'A 3rd-level evocation spell that creates a burst of flame.' },
        { name: 'Sword of Sharpness', category: 'item', definition: 'A magical weapon that can sever limbs on critical hits.' },
        { name: 'Ancient Red Dragon', category: 'creature', definition: 'A gargantuan dragon of immense power and cunning.' },
        { name: 'Waterdeep', category: 'location', definition: 'The City of Splendors, largest city on the Sword Coast.' },
        { name: 'Advantage', category: 'rule', definition: 'Roll two d20s and use the higher result.' },
        { name: 'Initiative', category: 'rule', definition: 'Determines the order of turns in combat.' }
    ];

    sampleTerms.forEach((term, index) => {
        terms.push({
            id: index + 1,
            name: term.name,
            definition: term.definition,
            category: term.category,
            status: statuses[index % statuses.length],
            source: 'Player\'s Handbook',
            page: `p. ${100 + index * 15}`,
            tags: ['combat', 'magic'].join(', '),
            usage_count: Math.floor(Math.random() * 100),
            is_public: true,
            last_updated: Date.now() - (index * 86400000) // Days ago
        });
    });

    return terms;
}

function updateTermsDisplay() {
    const tbody = document.querySelector('#terms-table tbody');
    const empty = document.getElementById('terms-empty');
    const pageSize = 25;

    tbody.innerHTML = '';
    selectedTerms.clear();

    if (filteredTerms.length === 0) {
        empty.style.display = 'block';
        updatePagination(0, 0);
        return;
    }

    empty.style.display = 'none';

    // Paginate results
    totalPages = Math.ceil(filteredTerms.length / pageSize);
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, filteredTerms.length);
    const pageTerms = filteredTerms.slice(startIndex, endIndex);

    pageTerms.forEach(term => {
        const tr = document.createElement('tr');
        const statusClass = `status-${term.status}`;
        const categoryClass = `category-${term.category}`;

        tr.innerHTML = `
            <td><input type="checkbox" class="term-checkbox" value="${term.id}" onchange="toggleTermSelection(${term.id}, this.checked)"></td>
            <td>
                <div>
                    <strong>${term.name}</strong>
                    <br>
                    <small class="text-muted">${term.definition.substring(0, 80)}${term.definition.length > 80 ? '...' : ''}</small>
                </div>
            </td>
            <td><span class="badge bg-light text-dark ${categoryClass}">${term.category}</span></td>
            <td><span class="status-badge ${statusClass}">${term.status}</span></td>
            <td><span class="badge bg-light text-dark">${term.usage_count}</span></td>
            <td>${AdminUtils.formatTimestamp(term.last_updated / 1000)}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-info btn-sm" onclick="viewTerm(${term.id})" title="View Details">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="editTerm(${term.id})" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteTerm(${term.id})" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });

    updatePagination(startIndex + 1, endIndex);
    updateBulkActions();
}

function updatePagination(start, end) {
    const info = document.getElementById('pagination-info');
    const controls = document.getElementById('pagination-controls');

    info.textContent = `Showing ${start}-${end} of ${filteredTerms.length} terms`;

    // Generate pagination controls
    controls.innerHTML = '';

    if (totalPages <= 1) return;

    // Previous button
    const prevBtn = document.createElement('li');
    prevBtn.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevBtn.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">&laquo;</a>`;
    controls.appendChild(prevBtn);

    // Page numbers
    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);

    if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('li');
        pageBtn.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageBtn.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        controls.appendChild(pageBtn);
    }

    // Next button
    const nextBtn = document.createElement('li');
    nextBtn.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextBtn.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">&raquo;</a>`;
    controls.appendChild(nextBtn);
}

function changePage(page) {
    if (page >= 1 && page <= totalPages && page !== currentPage) {
        currentPage = page;
        updateTermsDisplay();
    }
}

function filterTerms() {
    const searchText = document.getElementById('search-terms').value.toLowerCase();
    const categoryFilter = document.getElementById('category-filter').value;
    const statusFilter = document.getElementById('status-filter').value;

    filteredTerms = allTerms.filter(term => {
        const matchesSearch = !searchText ||
            term.name.toLowerCase().includes(searchText) ||
            term.definition.toLowerCase().includes(searchText) ||
            (term.tags && term.tags.toLowerCase().includes(searchText));

        const matchesCategory = !categoryFilter || term.category === categoryFilter;
        const matchesStatus = !statusFilter || term.status === statusFilter;

        return matchesSearch && matchesCategory && matchesStatus;
    });

    currentPage = 1;
    updateTermsDisplay();
}

function toggleTermSelection(termId, checked) {
    if (checked) {
        selectedTerms.add(termId);
    } else {
        selectedTerms.delete(termId);
    }
    updateBulkActions();
}

function toggleAllTerms(checked) {
    const checkboxes = document.querySelectorAll('.term-checkbox');
    selectedTerms.clear();

    checkboxes.forEach(cb => {
        cb.checked = checked;
        if (checked) {
            selectedTerms.add(parseInt(cb.value));
        }
    });
    updateBulkActions();
}

function updateBulkActions() {
    const deleteBtn = document.getElementById('delete-selected-btn');
    const selectAllBtn = document.getElementById('select-all-btn');

    if (selectedTerms.size > 0) {
        deleteBtn.style.display = 'inline-block';
        selectAllBtn.textContent = 'Clear Selection';
        selectAllBtn.onclick = clearSelection;
    } else {
        deleteBtn.style.display = 'none';
        selectAllBtn.textContent = 'Select All';
        selectAllBtn.onclick = selectAllTerms;
    }
}

function selectAllTerms() {
    document.getElementById('select-all-checkbox').checked = true;
    toggleAllTerms(true);
}

function clearSelection() {
    document.getElementById('select-all-checkbox').checked = false;
    toggleAllTerms(false);
}

// Term CRUD operations
function addNewTerm() {
    document.getElementById('termModalTitle').textContent = 'Add New Term';
    document.getElementById('termForm').reset();
    document.getElementById('termId').value = '';
    new bootstrap.Modal(document.getElementById('termModal')).show();
}

function editTerm(termId) {
    const term = allTerms.find(t => t.id === termId);
    if (!term) return;

    document.getElementById('termModalTitle').textContent = 'Edit Term';
    document.getElementById('termId').value = term.id;
    document.getElementById('termName').value = term.name;
    document.getElementById('termCategory').value = term.category;
    document.getElementById('termDefinition').value = term.definition;
    document.getElementById('termSource').value = term.source;
    document.getElementById('termPage').value = term.page;
    document.getElementById('termTags').value = term.tags;
    document.getElementById('termStatus').value = term.status;
    document.getElementById('termIsPublic').checked = term.is_public;

    new bootstrap.Modal(document.getElementById('termModal')).show();
}

function saveTerm() {
    const form = document.getElementById('termForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const termData = {
        id: document.getElementById('termId').value,
        name: document.getElementById('termName').value,
        category: document.getElementById('termCategory').value,
        definition: document.getElementById('termDefinition').value,
        source: document.getElementById('termSource').value,
        page: document.getElementById('termPage').value,
        tags: document.getElementById('termTags').value,
        status: document.getElementById('termStatus').value,
        is_public: document.getElementById('termIsPublic').checked,
        last_updated: Date.now()
    };

    // Mock save operation
    const isEdit = termData.id !== '';

    if (isEdit) {
        const index = allTerms.findIndex(t => t.id == termData.id);
        if (index !== -1) {
            allTerms[index] = { ...allTerms[index], ...termData };
        }
        AdminUtils.showToast('Term updated successfully', 'success');
    } else {
        termData.id = allTerms.length + 1;
        termData.usage_count = 0;
        allTerms.push(termData);
        AdminUtils.showToast('Term added successfully', 'success');
    }

    bootstrap.Modal.getInstance(document.getElementById('termModal')).hide();
    filterTerms(); // Refresh display
    loadDictionaryStats(); // Update stats
}

function viewTerm(termId) {
    const term = allTerms.find(t => t.id === termId);
    if (!term) return;

    // This would show a detailed view modal
    AdminUtils.showToast(`Viewing details for: ${term.name}`, 'info');
}

function deleteTerm(termId) {
    const term = allTerms.find(t => t.id === termId);
    if (!term || !confirm(`Delete term "${term.name}"?`)) return;

    const index = allTerms.findIndex(t => t.id === termId);
    if (index !== -1) {
        allTerms.splice(index, 1);
        AdminUtils.showToast('Term deleted successfully', 'success');
        filterTerms();
        loadDictionaryStats();
    }
}

function deleteSelectedTerms() {
    if (selectedTerms.size === 0) return;

    if (!confirm(`Delete ${selectedTerms.size} selected term(s)?`)) return;

    allTerms = allTerms.filter(term => !selectedTerms.has(term.id));
    selectedTerms.clear();

    AdminUtils.showToast('Selected terms deleted', 'success');
    filterTerms();
    loadDictionaryStats();
}

// Import/Export functions
function exportDictionary(format) {
    AdminUtils.showToast(`Preparing ${format.toUpperCase()} export...`, 'info');

    setTimeout(() => {
        const filename = `dictionary_export_${new Date().toISOString().split('T')[0]}.${format}`;
        AdminUtils.showToast(`Export ready: ${filename}`, 'success');
        // Mock download trigger
    }, 1500);
}

function importDictionary() {
    new bootstrap.Modal(document.getElementById('importModal')).show();
}

function performImport() {
    const fileInput = document.getElementById('importFile');
    const overwrite = document.getElementById('overwriteExisting').checked;

    if (!fileInput.files || fileInput.files.length === 0) {
        AdminUtils.showToast('Please select a file to import', 'warning');
        return;
    }

    AdminUtils.showToast('Processing import...', 'info');

    setTimeout(() => {
        const importedCount = Math.floor(Math.random() * 50) + 10;
        AdminUtils.showToast(`Successfully imported ${importedCount} terms`, 'success');
        bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
        refreshDictionary();
    }, 2000);
}

// Artifacts Management Functions
let allArtifacts = [];
let filteredArtifacts = [];

async function refreshArtifacts() {
    AdminUtils.showToast('Refreshing artifacts...', 'info');
    await Promise.all([
        loadArtifactsStats(),
        loadArtifacts()
    ]);
    AdminUtils.showToast('Artifacts refreshed', 'success');
}

async function loadArtifactsStats() {
      try {
          const envFilter = document.getElementById('artifact-env-filter');
          const selectedEnv = envFilter ? envFilter.value : 'dev';
          const environments = selectedEnv === 'all' ? ['dev', 'test', 'prod'] : [selectedEnv];

          let totalArtifacts = 0;
          let totalSize = 0;
          let linked = 0;

          for (const env of environments) {
              const response = await fetch(`/admin/api/dictionary/${env}/artifacts/stats`);
              if (!response.ok) {
                  throw new Error(`Failed to fetch artifact stats for ${env}`);
              }
              const stats = await response.json();
              totalArtifacts += stats.total_artifacts || 0;
              totalSize += stats.total_size_bytes || 0;
              linked += stats.linked_artifacts || 0;
          }

          const orphaned = Math.max(0, totalArtifacts - linked);

          document.getElementById('total-artifacts').textContent = totalArtifacts.toLocaleString();
          document.getElementById('total-artifact-size').textContent = AdminUtils.formatBytes(totalSize);
          document.getElementById('linked-artifacts').textContent = linked.toLocaleString();
          document.getElementById('orphaned-artifacts').textContent = orphaned.toLocaleString();

      } catch (error) {
          console.error('Failed to load artifacts stats:', error);
          AdminUtils.showToast('Failed to load artifact statistics', 'danger');
      }
  }



async function loadArtifacts() {
      try {
          const envFilter = document.getElementById('artifact-env-filter');
          const typeFilter = document.getElementById('artifact-type-filter');
          const sourceFilter = document.getElementById('artifact-source-filter');
          const entryFilter = document.getElementById('artifact-entry-filter');

          const selectedEnv = envFilter ? envFilter.value : 'dev';
          const environments = selectedEnv === 'all' ? ['dev', 'test', 'prod'] : [selectedEnv];
          const typeValue = typeFilter && typeFilter.value !== 'all' ? typeFilter.value : null;
          const sourceValue = sourceFilter ? sourceFilter.value.trim() : '';
          const entryValue = entryFilter ? entryFilter.value.trim() : '';

          allArtifacts = [];
          for (const env of environments) {
              const params = new URLSearchParams({ limit: '250' });
              if (typeValue) params.set('artifact_type', typeValue);
              if (sourceValue) params.set('source', sourceValue);
              const response = await fetch(`/admin/api/dictionary/${env}/artifacts?${params.toString()}`);
              if (!response.ok) {
                  throw new Error(`Failed to fetch artifacts for ${env}`);
              }
              const payload = await response.json();
              const records = (payload.artifacts || []).map(item => ({ ...item, environment: item.environment || env }));
              allArtifacts.push(...records);
          }

          filteredArtifacts = allArtifacts.filter(artifact => {
              if (selectedEnv !== 'all' && artifact.environment !== selectedEnv) {
                  return false;
              }
              if (entryValue) {
                  const entry = artifact.source_id || '';
                  if (!entry.toLowerCase().includes(entryValue.toLowerCase())) {
                      return false;
                  }
              }
              return true;
          });

          updateArtifactsDisplay();

      } catch (error) {
          console.error('Failed to load artifacts:', error);
          AdminUtils.showToast('Failed to load artifacts', 'danger');
      }
  }





function updateArtifactsDisplay() {
    const tbody = document.getElementById('artifacts-table-body');

    if (filteredArtifacts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted">
                    <i class="bi bi-archive me-2"></i>
                    No artifacts found. Try adjusting your filters.
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = filteredArtifacts.map(artifact => {
        const envClass = getEnvClass(artifact.environment);
        const typeIcon = getTypeIcon(artifact.type);
        const linkedIcon = artifact.linked ? '<i class="bi bi-link text-success" title="Linked to entry"></i>' : '<i class="bi bi-unlink text-warning" title="Orphaned"></i>';

        return `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        ${typeIcon}
                        <span class="ms-2">${artifact.name}</span>
                        <span class="ms-2">${linkedIcon}</span>
                    </div>
                </td>
                <td>${artifact.source}</td>
                <td>
                    ${artifact.linked ? `<a href="#" onclick="jumpToEntry('${artifact.dictionary_entry}')">${artifact.dictionary_entry}</a>` : '--'}
                </td>
                <td><code class="small">${artifact.chunk_page}</code></td>
                <td><span class="badge bg-light text-dark">${artifact.type}</span></td>
                <td>${AdminUtils.formatBytes(artifact.size_bytes)}</td>
                <td><span class="badge bg-${envClass}">${artifact.environment}</span></td>
                <td>${AdminUtils.formatTimestamp(artifact.modified_at / 1000)}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="viewArtifact('${artifact.id}')" title="View Artifact">
                            <i class="bi bi-eye"></i>
                        </button>
                        <a class="btn btn-outline-secondary btn-sm" href="/api/admin/artifacts/download?id=${artifact.id}" title="Download">
                            <i class="bi bi-download"></i>
                        </a>
                        ${artifact.linked ? '' : `<button class="btn btn-outline-success btn-sm" onclick="linkArtifact('${artifact.id}')" title="Link to Entry"><i class="bi bi-link"></i></button>`}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function getEnvClass(env) {
    switch (env) {
        case 'dev': return 'success';
        case 'test': return 'warning';
        case 'prod': return 'danger';
        default: return 'secondary';
    }
}

function getTypeIcon(type) {
    switch (type) {
        case 'json': return '<i class="bi bi-braces text-primary"></i>';
        case 'text': return '<i class="bi bi-file-text text-info"></i>';
        case 'log': return '<i class="bi bi-file-earmark-text text-warning"></i>';
        case 'metadata': return '<i class="bi bi-tags text-secondary"></i>';
        default: return '<i class="bi bi-file text-muted"></i>';
    }
}

function filterArtifacts() {
    const envFilter = document.getElementById('artifact-env-filter').value;
    const sourceFilter = document.getElementById('artifact-source-filter').value.toLowerCase();
    const entryFilter = document.getElementById('artifact-entry-filter').value.toLowerCase();
    const typeFilter = document.getElementById('artifact-type-filter').value;

    filteredArtifacts = allArtifacts.filter(artifact => {
        const matchesEnv = envFilter === 'all' || artifact.environment === envFilter;
        const matchesSource = !sourceFilter || artifact.source.toLowerCase().includes(sourceFilter);
        const matchesEntry = !entryFilter || artifact.dictionary_entry.toLowerCase().includes(entryFilter);
        const matchesType = typeFilter === 'all' || artifact.type === typeFilter;

        return matchesEnv && matchesSource && matchesEntry && matchesType;
    });

    updateArtifactsDisplay();
}

function viewArtifact(artifactId) {
    const artifact = allArtifacts.find(a => a.id == artifactId);
    if (!artifact) return;

    AdminUtils.showToast(`Viewing artifact: ${artifact.name}`, 'info');
    // This would open the artifact viewer modal
}

function linkArtifact(artifactId) {
    const artifact = allArtifacts.find(a => a.id == artifactId);
    if (!artifact) return;

    AdminUtils.showToast(`Linking artifact: ${artifact.name}`, 'info');
    // This would open a modal to select dictionary entry to link to
}

function jumpToEntry(entryName) {
    // Switch to dictionary terms tab and filter by entry name
    document.getElementById('terms-tab').click();
    document.getElementById('search-terms').value = entryName;
    filterTerms();
    AdminUtils.showToast(`Jumped to entry: ${entryName}`, 'info');
}

function exportArtifacts() {
    AdminUtils.showToast('Preparing artifacts export...', 'info');

    setTimeout(() => {
        const filename = `artifacts_export_${new Date().toISOString().split('T')[0]}.zip`;
        AdminUtils.showToast(`Export ready: ${filename}`, 'success');
        // Mock download trigger
    }, 1500);
}

// Initialize artifacts when tab is shown
document.getElementById('artifacts-tab').addEventListener('shown.bs.tab', function() {
    if (allArtifacts.length === 0) {
        refreshArtifacts();
    }
});
</script>
{% endblock %}

