{% extends "base.html" %}

{% block title %}Testing & Bugs - TTRPG Center Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">Testing & Bug Management</h1>
        <div class="mt-1">
            <span class="text-muted small me-3">
                <i class="bi bi-cpu me-1"></i>
                Environment:
                <span id="test-environment" class="badge bg-primary">All</span>
            </span>
            <span class="text-muted small me-3" id="test-suite-status">
                <i class="bi bi-shield-check me-1"></i>
                <span class="badge bg-secondary">Ready</span>
            </span>
        </div>
    </div>
    <div class="btn-group" role="group">
        <button class="btn btn-admin" onclick="runAllTests()">
            <i class="bi bi-play-circle me-1"></i>Run All Tests
        </button>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-gear me-1"></i>Actions
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="createTest()"><i class="bi bi-plus-circle me-2"></i>Create Test</a></li>
                <li><a class="dropdown-item" href="#" onclick="createBug()"><i class="bi bi-bug me-2"></i>Create Bug</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="exportTestResults()"><i class="bi bi-download me-2"></i>Export Results</a></li>
                <li><a class="dropdown-item" href="#" onclick="refreshTestingData()"><i class="bi bi-arrow-clockwise me-2"></i>Refresh All</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Environment Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label for="env-filter" class="form-label">Environment</label>
                        <select class="form-select" id="env-filter" onchange="filterByEnvironment(this.value)">
                            <option value="all">All Environments</option>
                            <option value="dev">Development</option>
                            <option value="test">Testing</option>
                            <option value="prod">Production</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="test-type-filter" class="form-label">Test Type</label>
                        <select class="form-select" id="test-type-filter" onchange="filterTests()">
                            <option value="all">All Types</option>
                            <option value="unit">Unit Tests</option>
                            <option value="functional">Functional Tests</option>
                            <option value="security">Security Tests</option>
                            <option value="regression">Regression Tests</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="test-status-filter" class="form-label">Test Status</label>
                        <select class="form-select" id="test-status-filter" onchange="filterTests()">
                            <option value="all">All Status</option>
                            <option value="passed">Passed</option>
                            <option value="failed">Failed</option>
                            <option value="pending">Pending</option>
                            <option value="running">Running</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="bug-severity-filter" class="form-label">Bug Severity</label>
                        <select class="form-select" id="bug-severity-filter" onchange="filterBugs()">
                            <option value="all">All Severities</option>
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-3">
                        <label for="bug-priority-filter" class="form-label">Priority</label>
                        <select class="form-select" id="bug-priority-filter" onchange="filterBugs()">
                            <option value="all">All Priorities</option>
                            <option value="urgent">Urgent</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="bug-component-filter" class="form-label">Component</label>
                        <select class="form-select" id="bug-component-filter" onchange="filterBugs()">
                            <option value="all">All Components</option>
                            <option value="ui">UI</option>
                            <option value="api">API</option>
                            <option value="database">Database</option>
                            <option value="authentication">Authentication</option>
                            <option value="security">Security</option>
                            <option value="performance">Performance</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="bug-assignee-filter" class="form-label">Assignee</label>
                        <select class="form-select" id="bug-assignee-filter" onchange="filterBugs()">
                            <option value="all">All Assignees</option>
                            <option value="unassigned">Unassigned</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="bug-search" class="form-label">Search</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="bug-search" placeholder="Search bugs..." onkeyup="searchBugs()">
                            <button class="btn btn-outline-secondary" type="button" onclick="clearBugSearch()">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Dashboard -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>Test Suite Overview</h5>
                <span class="badge bg-info" id="test-count">Loading...</span>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-3">
                        <div class="metric-value text-success" id="tests-passed">--</div>
                        <div class="metric-label">Passed</div>
                    </div>
                    <div class="col-3">
                        <div class="metric-value text-danger" id="tests-failed">--</div>
                        <div class="metric-label">Failed</div>
                    </div>
                    <div class="col-3">
                        <div class="metric-value text-warning" id="tests-pending">--</div>
                        <div class="metric-label">Pending</div>
                    </div>
                    <div class="col-3">
                        <div class="metric-value text-primary" id="tests-total">--</div>
                        <div class="metric-label">Total</div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" id="success-bar" style="width: 0%"></div>
                        <div class="progress-bar bg-danger" role="progressbar" id="failure-bar" style="width: 0%"></div>
                        <div class="progress-bar bg-warning" role="progressbar" id="pending-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-bug me-2"></i>Bug Tracking</h5>
                <span class="badge bg-warning" id="bug-count">Loading...</span>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-3">
                        <div class="metric-value text-danger" id="bugs-critical">--</div>
                        <div class="metric-label">Critical</div>
                    </div>
                    <div class="col-3">
                        <div class="metric-value text-warning" id="bugs-high">--</div>
                        <div class="metric-label">High</div>
                    </div>
                    <div class="col-3">
                        <div class="metric-value text-info" id="bugs-medium">--</div>
                        <div class="metric-label">Medium</div>
                    </div>
                    <div class="col-3">
                        <div class="metric-value text-secondary" id="bugs-low">--</div>
                        <div class="metric-label">Low</div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="d-flex justify-content-between text-sm">
                        <span>Open: <span class="fw-bold text-danger" id="bugs-open">--</span></span>
                        <span>In Progress: <span class="fw-bold text-warning" id="bugs-progress">--</span></span>
                        <span>Resolved: <span class="fw-bold text-success" id="bugs-resolved">--</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Suite Execution -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-play-circle me-2"></i>Test Suite Execution</h5>
                <div>
                    <span class="badge bg-secondary" id="test-execution-status">Ready</span>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="runTestSuite('unit')">
                                <i class="bi bi-play me-1"></i>Run Unit Tests
                            </button>
                            <button class="btn btn-info" onclick="runTestSuite('functional')">
                                <i class="bi bi-play me-1"></i>Run Functional Tests
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid gap-2">
                            <button class="btn btn-warning" onclick="runTestSuite('security')">
                                <i class="bi bi-shield-check me-1"></i>Run Security Tests
                            </button>
                            <button class="btn btn-primary" onclick="runTestSuite('regression')">
                                <i class="bi bi-arrow-repeat me-1"></i>Run Regression Tests
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid gap-2">
                            <button class="btn btn-admin" onclick="runAllTests()">
                                <i class="bi bi-play-circle me-1"></i>Run All Tests
                            </button>
                            <button class="btn btn-outline-danger" onclick="stopAllTests()">
                                <i class="bi bi-stop-circle me-1"></i>Stop All Tests
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Real-time Test Execution Status -->
                <div class="mt-3" id="test-execution-container" style="display: none;">
                    <hr>
                    <h6><i class="bi bi-activity me-2"></i>Test Execution Progress</h6>
                    <div id="test-execution-progress">
                        <!-- Real-time test progress will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Results and Bug List Tabs -->
<ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tests-tab" data-bs-toggle="tab" data-bs-target="#tests-pane" type="button" role="tab">
            <i class="bi bi-list-check me-1"></i>Test Results
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="bugs-tab" data-bs-toggle="tab" data-bs-target="#bugs-pane" type="button" role="tab">
            <i class="bi bi-bug me-1"></i>Bug Reports
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-pane" type="button" role="tab">
            <i class="bi bi-clock-history me-1"></i>Execution History
        </button>
    </li>
</ul>

<div class="tab-content" id="mainTabContent">
    <!-- Test Results Tab -->
    <div class="tab-pane fade show active" id="tests-pane" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Test Results</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="refreshTests()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportTestResults()">
                        <i class="bi bi-download me-1"></i>Export
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="tests-empty" class="text-center text-muted py-4" style="display:none;">
                    <i class="bi bi-clipboard-check display-4 mb-2"></i>
                    <p>No test results found.</p>
                    <small>Run tests to see results here.</small>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover table-sm" id="tests-table">
                        <thead>
                            <tr>
                                <th>Test Name</th>
                                <th style="width: 100px;">Type</th>
                                <th style="width: 100px;">Environment</th>
                                <th style="width: 100px;">Status</th>
                                <th style="width: 150px;">Last Run</th>
                                <th style="width: 100px;">Duration</th>
                                <th style="width: 80px;">Runs</th>
                                <th style="width: 120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tests-table-body">
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    <div class="loading-spinner"></div>
                                    Loading test results...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bug Reports Tab -->
    <div class="tab-pane fade" id="bugs-pane" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-bug me-2"></i>Bug Reports</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-admin" onclick="createBug()">
                        <i class="bi bi-plus-circle me-1"></i>Create Bug
                    </button>
                    <button class="btn btn-outline-primary" onclick="refreshBugs()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots me-1"></i>Bulk Actions
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showBulkAssignModal()"><i class="bi bi-person-check me-2"></i>Bulk Assign</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showBulkUpdateModal()"><i class="bi bi-pencil-square me-2"></i>Bulk Update</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="exportBugs()"><i class="bi bi-download me-2"></i>Export Selected</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showBugAnalytics()"><i class="bi bi-graph-up me-2"></i>Analytics</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="bugs-empty" class="text-center text-muted py-4" style="display:none;">
                    <i class="bi bi-bug display-4 mb-2"></i>
                    <p>No bug reports found.</p>
                    <small>Create bug reports for tracking issues.</small>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover table-sm" id="bugs-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" class="form-check-input" id="select-all-bugs" onchange="toggleAllBugs()">
                                </th>
                                <th>Bug ID</th>
                                <th>Title</th>
                                <th style="width: 80px;">Priority</th>
                                <th style="width: 80px;">Severity</th>
                                <th style="width: 100px;">Component</th>
                                <th style="width: 100px;">Status</th>
                                <th style="width: 100px;">Assignee</th>
                                <th style="width: 120px;">Created</th>
                                <th style="width: 120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bugs-table-body">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <div class="loading-spinner"></div>
                                    Loading bug reports...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Execution History Tab -->
    <div class="tab-pane fade" id="history-pane" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Test Execution History</h5>
            </div>
            <div class="card-body">
                <div id="execution-history">
                    <div class="text-center text-muted">
                        <div class="loading-spinner mb-2"></div>
                        <small>Loading execution history...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Details Modal -->
<div class="modal fade" id="testDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testDetailsTitle">Test Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="test-details-content">
                    <!-- Test details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-success" id="run-single-test" onclick="runSingleTest()">
                    <i class="bi bi-play me-1"></i>Run Test
                </button>
                <button type="button" class="btn btn-outline-danger" id="create-bug-from-test" onclick="createBugFromTest()">
                    <i class="bi bi-bug me-1"></i>Create Bug
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Bug Details/Edit Modal -->
<div class="modal fade" id="bugModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bugModalTitle">Bug Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bugForm">
                    <input type="hidden" id="bugId" value="">
                    <input type="hidden" id="bugEnvironment" value="">

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="bugTitle" class="form-label">Title *</label>
                            <input type="text" class="form-control" id="bugTitle" required>
                        </div>
                        <div class="col-md-4">
                            <label for="bugSeverity" class="form-label">Severity *</label>
                            <select class="form-select" id="bugSeverity" required>
                                <option value="">Select Severity</option>
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="bugPriority" class="form-label">Priority *</label>
                            <select class="form-select" id="bugPriority" required>
                                <option value="">Select Priority</option>
                                <option value="urgent">Urgent</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="bugComponent" class="form-label">Component *</label>
                            <select class="form-select" id="bugComponent" required>
                                <option value="">Select Component</option>
                                <option value="ui">UI</option>
                                <option value="api">API</option>
                                <option value="database">Database</option>
                                <option value="authentication">Authentication</option>
                                <option value="ingestion">Ingestion</option>
                                <option value="search">Search</option>
                                <option value="performance">Performance</option>
                                <option value="security">Security</option>
                                <option value="infrastructure">Infrastructure</option>
                                <option value="testing">Testing</option>
                                <option value="documentation">Documentation</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="bugAssignee" class="form-label">Assignee</label>
                            <input type="text" class="form-control" id="bugAssignee" placeholder="Assign to user">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="bugDescription" class="form-label">Description *</label>
                        <textarea class="form-control" id="bugDescription" rows="4" required></textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="bugStatus" class="form-label">Status</label>
                            <select class="form-select" id="bugStatus">
                                <option value="open">Open</option>
                                <option value="in_progress">In Progress</option>
                                <option value="needs_info">Needs Info</option>
                                <option value="testing">Testing</option>
                                <option value="resolved">Resolved</option>
                                <option value="closed">Closed</option>
                                <option value="duplicate">Duplicate</option>
                                <option value="wont_fix">Won't Fix</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="bugEnvSelect" class="form-label">Environment</label>
                            <select class="form-select" id="bugEnvSelect">
                                <option value="dev">Development</option>
                                <option value="test">Testing</option>
                                <option value="prod">Production</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="bugMilestone" class="form-label">Milestone</label>
                            <input type="text" class="form-control" id="bugMilestone" placeholder="Target milestone">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="bugSteps" class="form-label">Steps to Reproduce</label>
                        <textarea class="form-control" id="bugSteps" rows="3" placeholder="1. Step one&#10;2. Step two&#10;3. Step three"></textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="bugExpected" class="form-label">Expected Behavior</label>
                            <textarea class="form-control" id="bugExpected" rows="2"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="bugActual" class="form-label">Actual Behavior</label>
                            <textarea class="form-control" id="bugActual" rows="2"></textarea>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="bugTags" class="form-label">Tags</label>
                            <input type="text" class="form-control" id="bugTags" placeholder="ui, performance, security">
                            <div class="form-text">Comma-separated tags for categorization</div>
                        </div>
                        <div class="col-md-6">
                            <label for="bugLabels" class="form-label">Labels</label>
                            <input type="text" class="form-control" id="bugLabels" placeholder="frontend, critical-path">
                            <div class="form-text">Additional labels for organization</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="bugEstimation" class="form-label">Estimation (hours)</label>
                            <input type="number" class="form-control" id="bugEstimation" step="0.5" min="0">
                        </div>
                        <div class="col-md-4">
                            <label for="bugVersionFound" class="form-label">Version Found</label>
                            <input type="text" class="form-control" id="bugVersionFound" placeholder="v1.2.3">
                        </div>
                        <div class="col-md-4">
                            <label for="bugRelatedBugs" class="form-label">Related Bug IDs</label>
                            <input type="text" class="form-control" id="bugRelatedBugs" placeholder="BUG-123, BUG-456">
                            <div class="form-text">Comma-separated bug IDs</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-info" id="view-bug-activity" onclick="viewBugActivity()" style="display: none;">
                    <i class="bi bi-clock-history me-1"></i>View Activity
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-admin" onclick="saveBug()">Save Bug Report</button>
            </div>
        </div>
    </div>
</div>

<!-- Test Creation Modal -->
<div class="modal fade" id="testModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Test</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testForm">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="testName" class="form-label">Test Name *</label>
                            <input type="text" class="form-control" id="testName" required>
                        </div>
                        <div class="col-md-4">
                            <label for="testType" class="form-label">Test Type *</label>
                            <select class="form-select" id="testType" required>
                                <option value="">Select Type</option>
                                <option value="unit">Unit Test</option>
                                <option value="functional">Functional Test</option>
                                <option value="security">Security Test</option>
                                <option value="regression">Regression Test</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="testDescription" class="form-label">Description *</label>
                        <textarea class="form-control" id="testDescription" rows="3" required></textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="testEnvSelect" class="form-label">Environment *</label>
                            <select class="form-select" id="testEnvSelect" required>
                                <option value="dev">Development</option>
                                <option value="test">Testing</option>
                                <option value="prod">Production</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="testExpectedResult" class="form-label">Expected Result</label>
                            <input type="text" class="form-control" id="testExpectedResult" placeholder="Expected outcome">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="testCommand" class="form-label">Test Command *</label>
                        <textarea class="form-control" id="testCommand" rows="2" required placeholder="pytest tests/test_example.py"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="testTags" class="form-label">Tags</label>
                        <input type="text" class="form-control" id="testTags" placeholder="smoke, api, database">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-admin" onclick="saveTest()">Create Test</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Operations Modals -->
<div class="modal fade" id="bulkAssignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Assign Bugs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Assign <span id="bulk-assign-count">0</span> selected bugs to:</p>
                <div class="mb-3">
                    <label for="bulkAssignee" class="form-label">Assignee</label>
                    <input type="text" class="form-control" id="bulkAssignee" placeholder="Enter username" required>
                </div>
                <div id="bulk-assign-bug-list" class="mb-3">
                    <!-- Selected bugs will be listed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-admin" onclick="executeBulkAssign()">Assign Bugs</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bulkUpdateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Update Bugs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Update <span id="bulk-update-count">0</span> selected bugs:</p>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="bulkStatus" class="form-label">Status</label>
                        <select class="form-select" id="bulkStatus">
                            <option value="">Keep Current</option>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="needs_info">Needs Info</option>
                            <option value="testing">Testing</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="bulkPriority" class="form-label">Priority</label>
                        <select class="form-select" id="bulkPriority">
                            <option value="">Keep Current</option>
                            <option value="urgent">Urgent</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="bulkSeverity" class="form-label">Severity</label>
                        <select class="form-select" id="bulkSeverity">
                            <option value="">Keep Current</option>
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="bulkComponent" class="form-label">Component</label>
                        <select class="form-select" id="bulkComponent">
                            <option value="">Keep Current</option>
                            <option value="ui">UI</option>
                            <option value="api">API</option>
                            <option value="database">Database</option>
                            <option value="authentication">Authentication</option>
                            <option value="security">Security</option>
                            <option value="performance">Performance</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="bulkAssigneeUpdate" class="form-label">Assignee</label>
                    <input type="text" class="form-control" id="bulkAssigneeUpdate" placeholder="Leave empty to keep current">
                </div>
                <div id="bulk-update-bug-list" class="mb-3">
                    <!-- Selected bugs will be listed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-admin" onclick="executeBulkUpdate()">Update Bugs</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bugActivityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activityModalTitle">Bug Activity Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="bug-activity-content">
                    <!-- Activity log will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" onclick="addBugComment()">
                    <i class="bi bi-chat-left-text me-1"></i>Add Comment
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bugAnalyticsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bug Analytics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="bug-analytics-content">
                    <!-- Analytics charts and data will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.metric-value {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
}

.metric-label {
    color: var(--admin-secondary);
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.test-status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-weight: 500;
}

.test-status-passed { background: #dcfce7; color: #166534; }
.test-status-failed { background: #fecaca; color: #991b1b; }
.test-status-pending { background: #fef3c7; color: #92400e; }
.test-status-running { background: #dbeafe; color: #1d4ed8; }
.test-status-error { background: #fecaca; color: #991b1b; }

.bug-severity-critical { background: #fecaca; color: #991b1b; font-weight: bold; }
.bug-severity-high { background: #fed7aa; color: #9a3412; }
.bug-severity-medium { background: #fef3c7; color: #92400e; }
.bug-severity-low { background: #f3f4f6; color: #374151; }

.bug-priority-urgent { background: #ef4444; color: white; font-weight: bold; }
.bug-priority-high { background: #f97316; color: white; }
.bug-priority-medium { background: #eab308; color: white; }
.bug-priority-low { background: #84cc16; color: white; }

.activity-item {
    border-left-color: #3b82f6 !important;
}

.execution-item {
    border-left: 4px solid #e5e7eb;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: #f9fafb;
    border-radius: 0.25rem;
}

.execution-item.status-passed { border-left-color: #10b981; }
.execution-item.status-failed { border-left-color: #ef4444; }
.execution-item.status-running { border-left-color: #3b82f6; }

.progress-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e5e7eb;
}

.progress-item:last-child {
    border-bottom: none;
}

.test-output {
    background: #1e1e1e;
    color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.875rem;
    white-space: pre-wrap;
    max-height: 300px;
    overflow-y: auto;
}
</style>

{% endblock %}

{% block extra_scripts %}
<script>
let currentEnvironment = 'all';
let testsData = [];
let bugsData = [];
let executionHistory = [];
let currentTestId = null;
let currentBugId = null;
let selectedBugs = new Set();
let filterOptions = {};
let activeTestExecutions = new Map();

// WebSocket connection for real-time test updates with proper cleanup
let testWs = null;
let isPageVisible = true;
let reconnectTimeout = null;

function connectTestWebSocket() {
    if (testWs && testWs.readyState === WebSocket.OPEN) {
        return;
    }

    // Only connect if page is visible
    if (!isPageVisible) {
        console.log('Page not visible - WebSocket connection deferred');
        return;
    }

    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    testWs = new WebSocket(`${protocol}//${location.host}/ws/admin/testing`);

    testWs.onopen = function() {
        console.log('Test WebSocket connected');
        // Clear any pending reconnect timeout
        if (reconnectTimeout) {
            clearTimeout(reconnectTimeout);
            reconnectTimeout = null;
        }
    };

    testWs.onmessage = function(event) {
        const data = JSON.parse(event.data);
        handleTestWebSocketMessage(data);
    };

    testWs.onclose = function() {
        console.log('Test WebSocket disconnected');
        testWs = null;

        // Only attempt reconnection if page is still visible
        if (isPageVisible) {
            console.log('Scheduling WebSocket reconnect...');
            reconnectTimeout = setTimeout(connectTestWebSocket, 5000);
        }
    };

    testWs.onerror = function(error) {
        console.error('Test WebSocket error:', error);
    };
}

function disconnectTestWebSocket() {
    if (reconnectTimeout) {
        clearTimeout(reconnectTimeout);
        reconnectTimeout = null;
    }

    if (testWs) {
        testWs.close();
        testWs = null;
        console.log('Test WebSocket disconnected and cleaned up');
    }
}

function handleTestWebSocketMessage(data) {
    switch(data.type) {
        case 'test_execution_started':
            handleTestExecutionStarted(data.data);
            break;
        case 'test_execution_progress':
            handleTestExecutionProgress(data.data);
            break;
        case 'test_execution_completed':
            handleTestExecutionCompleted(data.data);
            break;
        case 'test_suite_started':
            handleTestSuiteStarted(data.data);
            break;
        case 'test_suite_completed':
            handleTestSuiteCompleted(data.data);
            break;
    }
}

// Initialize page with proper cleanup handlers
document.addEventListener('DOMContentLoaded', function() {
    loadTestingData();
    connectTestWebSocket();
    setupVisibilityHandlers();
    setupCleanupHandlers();

    // Setup tab change handlers
    document.querySelectorAll('#mainTabs button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            const target = event.target.getAttribute('data-bs-target');
            if (target === '#history-pane') {
                loadExecutionHistory();
            }
        });
    });
});

// Visibility-based WebSocket management
function setupVisibilityHandlers() {
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            // Page is now hidden - disconnect WebSocket to save resources
            isPageVisible = false;
            disconnectTestWebSocket();
            console.log('Testing page hidden - WebSocket disconnected');
        } else {
            // Page is now visible - reconnect WebSocket
            isPageVisible = true;
            connectTestWebSocket();
            console.log('Testing page visible - WebSocket reconnecting');
            // Refresh data when page becomes visible
            loadTestingData();
        }
    });
}

// Proper cleanup on page unload
function setupCleanupHandlers() {
    window.addEventListener('beforeunload', function() {
        console.log('Testing page unloading - cleaning up WebSocket connections');
        disconnectTestWebSocket();
    });

    window.addEventListener('pagehide', function() {
        console.log('Testing page hiding - cleaning up WebSocket connections');
        disconnectTestWebSocket();
    });
}

async function loadTestingData() {
    AdminUtils.showToast('Loading testing data...', 'info');
    await Promise.all([
        loadTestingOverview(),
        loadTests(),
        loadBugs()
    ]);
    AdminUtils.showToast('Testing data loaded', 'success');
}

async function loadTestingOverview() {
    try {
        const response = await fetch('/api/admin/testing/overview');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        updateTestingOverview(data);
    } catch (error) {
        console.error('Error loading testing overview:', error);
        AdminUtils.showToast('Failed to load testing overview', 'danger');
    }
}

function updateTestingOverview(data) {
    // Update test metrics
    const envData = data.environments[currentEnvironment] || calculateAllEnvironments(data.environments);

    if (envData.test_stats) {
        const stats = envData.test_stats;
        document.getElementById('tests-passed').textContent = stats.by_status.passed || 0;
        document.getElementById('tests-failed').textContent = stats.by_status.failed || 0;
        document.getElementById('tests-pending').textContent = stats.by_status.pending || 0;
        document.getElementById('tests-total').textContent = stats.total || 0;

        // Update progress bar
        const total = stats.total || 1;
        const passedPct = ((stats.by_status.passed || 0) / total) * 100;
        const failedPct = ((stats.by_status.failed || 0) / total) * 100;
        const pendingPct = ((stats.by_status.pending || 0) / total) * 100;

        document.getElementById('success-bar').style.width = `${passedPct}%`;
        document.getElementById('failure-bar').style.width = `${failedPct}%`;
        document.getElementById('pending-bar').style.width = `${pendingPct}%`;

        document.getElementById('test-count').textContent = `${stats.total || 0} Tests`;
    }

    // Update bug metrics
    if (envData.bug_stats) {
        const bugStats = envData.bug_stats;
        document.getElementById('bugs-critical').textContent = bugStats.by_severity.critical || 0;
        document.getElementById('bugs-high').textContent = bugStats.by_severity.high || 0;
        document.getElementById('bugs-medium').textContent = bugStats.by_severity.medium || 0;
        document.getElementById('bugs-low').textContent = bugStats.by_severity.low || 0;

        document.getElementById('bugs-open').textContent = bugStats.by_status.open || 0;
        document.getElementById('bugs-progress').textContent = bugStats.by_status.in_progress || 0;
        document.getElementById('bugs-resolved').textContent = bugStats.by_status.resolved || 0;

        document.getElementById('bug-count').textContent = `${bugStats.total || 0} Bugs`;
    }
}

function calculateAllEnvironments(environments) {
    const combined = {
        test_stats: { total: 0, by_status: {}, by_type: {} },
        bug_stats: { total: 0, by_severity: {}, by_status: {} }
    };

    Object.values(environments).forEach(env => {
        if (env.test_stats) {
            combined.test_stats.total += env.test_stats.total;
            Object.entries(env.test_stats.by_status).forEach(([status, count]) => {
                combined.test_stats.by_status[status] = (combined.test_stats.by_status[status] || 0) + count;
            });
        }
        if (env.bug_stats) {
            combined.bug_stats.total += env.bug_stats.total;
            Object.entries(env.bug_stats.by_severity).forEach(([severity, count]) => {
                combined.bug_stats.by_severity[severity] = (combined.bug_stats.by_severity[severity] || 0) + count;
            });
            Object.entries(env.bug_stats.by_status).forEach(([status, count]) => {
                combined.bug_stats.by_status[status] = (combined.bug_stats.by_status[status] || 0) + count;
            });
        }
    });

    return combined;
}

async function loadTests() {
    try {
        let url = '/api/admin/testing/tests';
        if (currentEnvironment !== 'all') {
            url += `?environment=${currentEnvironment}`;
        }

        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        testsData = await response.json();
        updateTestsDisplay();
    } catch (error) {
        console.error('Error loading tests:', error);
        AdminUtils.showToast('Failed to load tests', 'danger');
    }
}

function updateTestsDisplay() {
    const tbody = document.getElementById('tests-table-body');
    const empty = document.getElementById('tests-empty');

    if (testsData.length === 0) {
        empty.style.display = 'block';
        tbody.innerHTML = '';
        return;
    }

    empty.style.display = 'none';

    tbody.innerHTML = testsData.map(test => {
        const statusClass = `test-status-${test.status}`;
        const lastRun = test.last_run ? AdminUtils.formatTimestamp(test.last_run) : 'Never';
        const duration = test.duration_seconds ? `${test.duration_seconds.toFixed(2)}s` : '--';

        return `
            <tr>
                <td>
                    <div>
                        <strong>${test.name}</strong>
                        <br>
                        <small class="text-muted">${test.description}</small>
                    </div>
                </td>
                <td><span class="badge bg-light text-dark">${test.test_type}</span></td>
                <td><span class="badge bg-info">${test.environment}</span></td>
                <td><span class="test-status-badge ${statusClass}">${test.status}</span></td>
                <td>${lastRun}</td>
                <td>${duration}</td>
                <td><span class="badge bg-secondary">${test.run_count || 0}</span></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info btn-sm" onclick="viewTestDetails('${test.test_id}')" title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="runSingleTestById('${test.test_id}')" title="Run Test">
                            <i class="bi bi-play"></i>
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="createBugFromTestId('${test.test_id}')" title="Create Bug">
                            <i class="bi bi-bug"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

async function loadBugs() {
    try {
        let url = '/api/admin/testing/bugs';
        if (currentEnvironment !== 'all') {
            url += `?environment=${currentEnvironment}`;
        }

        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        bugsData = await response.json();
        updateBugsDisplay();
    } catch (error) {
        console.error('Error loading bugs:', error);
        AdminUtils.showToast('Failed to load bugs', 'danger');
    }
}

function updateBugsDisplay() {
    const tbody = document.getElementById('bugs-table-body');
    const empty = document.getElementById('bugs-empty');

    if (bugsData.length === 0) {
        empty.style.display = 'block';
        tbody.innerHTML = '';
        return;
    }

    empty.style.display = 'none';

    tbody.innerHTML = bugsData.map(bug => {
        const severityClass = `bug-severity-${bug.severity}`;
        const priorityClass = `bug-priority-${bug.priority}`;
        const statusClass = getStatusClass(bug.status);
        const created = AdminUtils.formatTimestamp(bug.created_at);
        const assignee = bug.assigned_to || 'Unassigned';
        const isSelected = selectedBugs.has(bug.bug_id);

        return `
            <tr class="${isSelected ? 'table-active' : ''}">
                <td>
                    <input type="checkbox" class="form-check-input bug-checkbox"
                           value="${bug.bug_id}" ${isSelected ? 'checked' : ''}
                           onchange="toggleBugSelection('${bug.bug_id}')">
                </td>
                <td><code>${bug.bug_id.substring(0, 8)}...</code></td>
                <td>
                    <div>
                        <strong>${bug.title}</strong>
                        <br>
                        <small class="text-muted">${bug.description.substring(0, 60)}${bug.description.length > 60 ? '...' : ''}</small>
                        ${bug.test_failure_id ? '<br><span class="badge bg-warning text-dark"><i class="bi bi-bug me-1"></i>Auto-created</span>' : ''}
                    </div>
                </td>
                <td><span class="badge ${priorityClass}">${bug.priority}</span></td>
                <td><span class="badge ${severityClass}">${bug.severity}</span></td>
                <td><span class="badge bg-secondary">${bug.component}</span></td>
                <td><span class="badge ${statusClass}">${bug.status.replace('_', ' ')}</span></td>
                <td><small>${assignee}</small></td>
                <td><small>${created}</small></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info btn-sm" onclick="viewBugDetails('${bug.bug_id}')" title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="editBug('${bug.bug_id}')" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="viewBugActivity('${bug.bug_id}')" title="Activity Log">
                            <i class="bi bi-clock-history"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');

    // Update selection count
    updateSelectionCount();
}

function getStatusClass(status) {
    switch(status) {
        case 'open': return 'bg-danger';
        case 'in_progress': return 'bg-warning';
        case 'resolved': return 'bg-success';
        case 'closed': return 'bg-secondary';
        default: return 'bg-light text-dark';
    }
}

// Test execution functions
async function runTestSuite(testType) {
    try {
        AdminUtils.showToast(`Starting ${testType} test suite...`, 'info');
        updateTestExecutionStatus('running', `Running ${testType} tests...`);

        const response = await fetch('/api/admin/testing/run-suite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                environment: currentEnvironment === 'all' ? 'dev' : currentEnvironment,
                test_type: testType
            })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const result = await response.json();
        showTestExecutionProgress(result.suite_id);

    } catch (error) {
        console.error('Error running test suite:', error);
        AdminUtils.showToast('Failed to start test suite', 'danger');
        updateTestExecutionStatus('error', 'Failed to start tests');
    }
}

async function runAllTests() {
    if (!confirm('This will run all test suites. Continue?')) return;

    try {
        AdminUtils.showToast('Starting full test suite...', 'info');
        updateTestExecutionStatus('running', 'Running all tests...');

        const response = await fetch('/api/admin/testing/run-all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                environment: currentEnvironment === 'all' ? 'dev' : currentEnvironment
            })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const result = await response.json();
        showTestExecutionProgress(result.suite_id);

    } catch (error) {
        console.error('Error running all tests:', error);
        AdminUtils.showToast('Failed to start test suite', 'danger');
        updateTestExecutionStatus('error', 'Failed to start tests');
    }
}

async function runSingleTestById(testId) {
    try {
        AdminUtils.showToast('Running test...', 'info');

        const response = await fetch(`/api/admin/testing/run-test/${testId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                environment: currentEnvironment === 'all' ? 'dev' : currentEnvironment
            })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const result = await response.json();
        AdminUtils.showToast(`Test started: ${result.execution_id}`, 'success');

        // Refresh tests to show updated status
        setTimeout(() => loadTests(), 1000);

    } catch (error) {
        console.error('Error running test:', error);
        AdminUtils.showToast('Failed to run test', 'danger');
    }
}

function updateTestExecutionStatus(status, message) {
    const statusElement = document.getElementById('test-execution-status');
    const container = document.getElementById('test-execution-container');

    if (status === 'running') {
        statusElement.className = 'badge bg-primary';
        statusElement.textContent = 'Running';
        container.style.display = 'block';
    } else if (status === 'completed') {
        statusElement.className = 'badge bg-success';
        statusElement.textContent = 'Completed';
    } else if (status === 'error') {
        statusElement.className = 'badge bg-danger';
        statusElement.textContent = 'Error';
    } else {
        statusElement.className = 'badge bg-secondary';
        statusElement.textContent = 'Ready';
        container.style.display = 'none';
    }
}

function showTestExecutionProgress(suiteId) {
    const progressContainer = document.getElementById('test-execution-progress');
    activeTestExecutions.set(suiteId, {
        startTime: Date.now(),
        tests: []
    });

    progressContainer.innerHTML = `
        <div class="progress-item">
            <span><strong>Suite ID:</strong> ${suiteId}</span>
            <span class="badge bg-primary">Starting...</span>
        </div>
    `;
}

// WebSocket event handlers
function handleTestExecutionStarted(data) {
    const progressContainer = document.getElementById('test-execution-progress');
    const suiteExecution = activeTestExecutions.get(data.suite_id);

    if (suiteExecution) {
        const progressHtml = `
            <div class="progress-item" id="test-${data.test_id}">
                <span>${data.test_name}</span>
                <span class="badge bg-primary">
                    <i class="bi bi-arrow-clockwise"></i> Running
                </span>
            </div>
        `;
        progressContainer.insertAdjacentHTML('beforeend', progressHtml);
    }
}

function handleTestExecutionProgress(data) {
    const testElement = document.getElementById(`test-${data.test_id}`);
    if (testElement) {
        const badge = testElement.querySelector('.badge');
        badge.innerHTML = `<i class="bi bi-arrow-clockwise"></i> ${data.progress}%`;
    }
}

function handleTestExecutionCompleted(data) {
    const testElement = document.getElementById(`test-${data.test_id}`);
    if (testElement) {
        const badge = testElement.querySelector('.badge');
        const statusIcon = data.status === 'passed' ? 'check-circle' : 'x-circle';
        const statusClass = data.status === 'passed' ? 'bg-success' : 'bg-danger';

        badge.className = `badge ${statusClass}`;
        badge.innerHTML = `<i class="bi bi-${statusIcon}"></i> ${data.status}`;
    }

    // Refresh tests display
    loadTests();
}

function handleTestSuiteCompleted(data) {
    updateTestExecutionStatus('completed', 'Tests completed');
    AdminUtils.showToast(`Test suite completed: ${data.passed}/${data.total} passed`,
                        data.passed === data.total ? 'success' : 'warning');

    // Refresh all data
    loadTestingData();
    loadExecutionHistory();
}

// Modal functions
async function viewTestDetails(testId) {
    try {
        const response = await fetch(`/api/admin/testing/test/${testId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const test = await response.json();
        currentTestId = testId;

        document.getElementById('testDetailsTitle').textContent = `Test: ${test.name}`;
        document.getElementById('test-details-content').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <strong>Type:</strong> ${test.test_type}<br>
                    <strong>Environment:</strong> ${test.environment}<br>
                    <strong>Status:</strong> <span class="test-status-badge test-status-${test.status}">${test.status}</span><br>
                    <strong>Created:</strong> ${AdminUtils.formatTimestamp(test.created_at)}<br>
                </div>
                <div class="col-md-6">
                    <strong>Last Run:</strong> ${test.last_run ? AdminUtils.formatTimestamp(test.last_run) : 'Never'}<br>
                    <strong>Run Count:</strong> ${test.run_count || 0}<br>
                    <strong>Failure Count:</strong> ${test.failure_count || 0}<br>
                    <strong>Duration:</strong> ${test.duration_seconds ? `${test.duration_seconds.toFixed(2)}s` : '--'}<br>
                </div>
            </div>
            <hr>
            <div class="mb-3">
                <strong>Description:</strong><br>
                ${test.description}
            </div>
            <div class="mb-3">
                <strong>Command:</strong><br>
                <code>${test.command}</code>
            </div>
            <div class="mb-3">
                <strong>Expected Result:</strong><br>
                ${test.expected_result}
            </div>
            ${test.last_result ? `
            <div class="mb-3">
                <strong>Last Result:</strong><br>
                <div class="test-output">${test.last_result}</div>
            </div>
            ` : ''}
            ${test.tags ? `
            <div>
                <strong>Tags:</strong> ${test.tags.map(tag => `<span class="badge bg-light text-dark">${tag}</span>`).join(' ')}
            </div>
            ` : ''}
        `;

        new bootstrap.Modal(document.getElementById('testDetailsModal')).show();

    } catch (error) {
        console.error('Error loading test details:', error);
        AdminUtils.showToast('Failed to load test details', 'danger');
    }
}

function runSingleTest() {
    if (currentTestId) {
        runSingleTestById(currentTestId);
        bootstrap.Modal.getInstance(document.getElementById('testDetailsModal')).hide();
    }
}

function createBugFromTest() {
    if (currentTestId) {
        createBugFromTestId(currentTestId);
        bootstrap.Modal.getInstance(document.getElementById('testDetailsModal')).hide();
    }
}

function createBugFromTestId(testId) {
    const test = testsData.find(t => t.test_id === testId);
    if (!test) return;

    // Pre-fill bug form with test information
    document.getElementById('bugId').value = '';
    document.getElementById('bugTitle').value = `Test Failure: ${test.name}`;
    document.getElementById('bugDescription').value = `Test "${test.name}" is failing.\n\nTest Type: ${test.test_type}\nCommand: ${test.command}\nExpected: ${test.expected_result}`;
    document.getElementById('bugSeverity').value = test.test_type === 'security' ? 'critical' : 'medium';
    document.getElementById('bugPriority').value = test.test_type === 'security' ? 'urgent' : 'high';
    document.getElementById('bugComponent').value = getComponentFromTestType(test.test_type, test.tags || []);
    document.getElementById('bugStatus').value = 'open';
    document.getElementById('bugEnvSelect').value = test.environment;
    document.getElementById('bugExpected').value = test.expected_result;
    document.getElementById('bugActual').value = test.last_result || 'Test execution failed';
    document.getElementById('bugSteps').value = `1. Run test: ${test.command}\n2. Observe failure\n3. Check test output`;
    document.getElementById('bugTags').value = `test-failure,${test.test_type},automated`;
    document.getElementById('bugLabels').value = `test-type:${test.test_type}`;

    document.getElementById('bugModalTitle').textContent = 'Create Bug from Test Failure';
    new bootstrap.Modal(document.getElementById('bugModal')).show();
}

function getComponentFromTestType(testType, tags) {
    const componentMap = {
        'security': 'security',
        'api': 'api',
        'ui': 'ui',
        'database': 'database',
        'performance': 'performance'
    };

    // Check test type first
    if (componentMap[testType]) {
        return componentMap[testType];
    }

    // Check tags
    for (const tag of tags) {
        if (componentMap[tag.toLowerCase()]) {
            return componentMap[tag.toLowerCase()];
        }
    }

    return 'other';
}

function createBug() {
    // Clear form for new bug
    document.getElementById('bugForm').reset();
    document.getElementById('bugId').value = '';
    document.getElementById('bugStatus').value = 'open';
    document.getElementById('bugPriority').value = 'medium';
    document.getElementById('bugComponent').value = 'other';
    document.getElementById('bugEnvSelect').value = currentEnvironment === 'all' ? 'dev' : currentEnvironment;

    // Hide activity button for new bugs
    document.getElementById('view-bug-activity').style.display = 'none';

    document.getElementById('bugModalTitle').textContent = 'Create New Bug Report';
    new bootstrap.Modal(document.getElementById('bugModal')).show();
}

async function editBug(bugId) {
    try {
        const bug = bugsData.find(b => b.bug_id === bugId);
        if (!bug) {
            AdminUtils.showToast('Bug not found', 'danger');
            return;
        }

        // Populate form with bug data
        document.getElementById('bugId').value = bug.bug_id;
        document.getElementById('bugTitle').value = bug.title;
        document.getElementById('bugDescription').value = bug.description;
        document.getElementById('bugSeverity').value = bug.severity;
        document.getElementById('bugPriority').value = bug.priority;
        document.getElementById('bugComponent').value = bug.component;
        document.getElementById('bugStatus').value = bug.status;
        document.getElementById('bugEnvSelect').value = bug.environment;
        document.getElementById('bugAssignee').value = bug.assigned_to || '';
        document.getElementById('bugExpected').value = bug.expected_behavior || '';
        document.getElementById('bugActual').value = bug.actual_behavior || '';
        document.getElementById('bugSteps').value = (bug.steps_to_reproduce || []).join('\n');
        document.getElementById('bugTags').value = (bug.tags || []).join(', ');
        document.getElementById('bugLabels').value = (bug.labels || []).join(', ');
        document.getElementById('bugMilestone').value = bug.milestone || '';
        document.getElementById('bugEstimation').value = bug.estimation_hours || '';
        document.getElementById('bugVersionFound').value = bug.version_found || '';
        document.getElementById('bugRelatedBugs').value = (bug.related_bugs || []).join(', ');

        // Show activity button for existing bugs
        document.getElementById('view-bug-activity').style.display = 'inline-block';
        currentBugId = bugId;

        document.getElementById('bugModalTitle').textContent = `Edit Bug: ${bug.title}`;
        new bootstrap.Modal(document.getElementById('bugModal')).show();
    } catch (error) {
        console.error('Error loading bug for edit:', error);
        AdminUtils.showToast('Failed to load bug details', 'danger');
    }
}

async function saveBug() {
    const form = document.getElementById('bugForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const bugData = {
        title: document.getElementById('bugTitle').value,
        description: document.getElementById('bugDescription').value,
        severity: document.getElementById('bugSeverity').value,
        priority: document.getElementById('bugPriority').value,
        component: document.getElementById('bugComponent').value,
        status: document.getElementById('bugStatus').value,
        environment: document.getElementById('bugEnvSelect').value,
        assigned_to: document.getElementById('bugAssignee').value || null,
        expected_behavior: document.getElementById('bugExpected').value,
        actual_behavior: document.getElementById('bugActual').value,
        steps_to_reproduce: document.getElementById('bugSteps').value.split('\n').filter(s => s.trim()),
        tags: document.getElementById('bugTags').value.split(',').map(t => t.trim()).filter(t => t),
        labels: document.getElementById('bugLabels').value.split(',').map(t => t.trim()).filter(t => t),
        milestone: document.getElementById('bugMilestone').value || null,
        estimation_hours: parseFloat(document.getElementById('bugEstimation').value) || null,
        version_found: document.getElementById('bugVersionFound').value || null,
        related_bugs: document.getElementById('bugRelatedBugs').value.split(',').map(t => t.trim()).filter(t => t)
    };

    try {
        const bugId = document.getElementById('bugId').value;
        const isEdit = !!bugId;

        let url, method;
        if (isEdit) {
            url = `/api/admin/testing/bug/${bugId}?environment=${bugData.environment}&updated_by=admin`;
            method = 'PUT';
        } else {
            url = '/api/admin/testing/bugs';
            method = 'POST';
        }

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bugData)
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const result = await response.json();
        AdminUtils.showToast(`Bug ${isEdit ? 'updated' : 'created'} successfully`, 'success');

        bootstrap.Modal.getInstance(document.getElementById('bugModal')).hide();
        loadBugs();
        loadTestingOverview();

    } catch (error) {
        console.error('Error saving bug:', error);
        AdminUtils.showToast('Failed to save bug', 'danger');
    }
}

function createTest() {
    document.getElementById('testForm').reset();
    document.getElementById('testEnvSelect').value = currentEnvironment === 'all' ? 'dev' : currentEnvironment;
    new bootstrap.Modal(document.getElementById('testModal')).show();
}

async function saveTest() {
    const form = document.getElementById('testForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const testData = {
        name: document.getElementById('testName').value,
        description: document.getElementById('testDescription').value,
        test_type: document.getElementById('testType').value,
        environment: document.getElementById('testEnvSelect').value,
        command: document.getElementById('testCommand').value,
        expected_result: document.getElementById('testExpectedResult').value,
        tags: document.getElementById('testTags').value.split(',').map(t => t.trim()).filter(t => t)
    };

    try {
        const response = await fetch('/api/admin/testing/tests', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(testData)
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        AdminUtils.showToast('Test created successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('testModal')).hide();
        loadTests();
        loadTestingOverview();

    } catch (error) {
        console.error('Error creating test:', error);
        AdminUtils.showToast('Failed to create test', 'danger');
    }
}

// Enhanced Filter functions
function filterByEnvironment(environment) {
    currentEnvironment = environment;
    document.getElementById('test-environment').textContent = environment === 'all' ? 'All' : environment.toUpperCase();
    document.getElementById('test-environment').className = `badge bg-${environment === 'all' ? 'primary' : 'info'}`;

    loadTestingData();
}

function filterTests() {
    // Client-side filtering implementation
    updateTestsDisplay();
}

function filterBugs() {
    // Apply client-side filtering
    const filters = {
        severity: document.getElementById('bug-severity-filter').value,
        priority: document.getElementById('bug-priority-filter').value,
        component: document.getElementById('bug-component-filter').value,
        assignee: document.getElementById('bug-assignee-filter').value,
        search: document.getElementById('bug-search').value
    };

    let filteredBugs = [...bugsData];

    // Apply filters
    if (filters.severity && filters.severity !== 'all') {
        filteredBugs = filteredBugs.filter(bug => bug.severity === filters.severity);
    }
    if (filters.priority && filters.priority !== 'all') {
        filteredBugs = filteredBugs.filter(bug => bug.priority === filters.priority);
    }
    if (filters.component && filters.component !== 'all') {
        filteredBugs = filteredBugs.filter(bug => bug.component === filters.component);
    }
    if (filters.assignee && filters.assignee !== 'all') {
        if (filters.assignee === 'unassigned') {
            filteredBugs = filteredBugs.filter(bug => !bug.assigned_to);
        } else {
            filteredBugs = filteredBugs.filter(bug => bug.assigned_to === filters.assignee);
        }
    }
    if (filters.search) {
        const searchLower = filters.search.toLowerCase();
        filteredBugs = filteredBugs.filter(bug =>
            bug.title.toLowerCase().includes(searchLower) ||
            bug.description.toLowerCase().includes(searchLower) ||
            (bug.tags && bug.tags.some(tag => tag.toLowerCase().includes(searchLower)))
        );
    }

    // Update display with filtered data
    const originalBugsData = bugsData;
    bugsData = filteredBugs;
    updateBugsDisplay();
    bugsData = originalBugsData; // Restore original data
}

function searchBugs() {
    // Trigger filtering when search input changes
    filterBugs();
}

function clearBugSearch() {
    document.getElementById('bug-search').value = '';
    filterBugs();
}

// Bug selection management
function toggleBugSelection(bugId) {
    if (selectedBugs.has(bugId)) {
        selectedBugs.delete(bugId);
    } else {
        selectedBugs.add(bugId);
    }
    updateBugsDisplay();
}

function toggleAllBugs() {
    const selectAllCheckbox = document.getElementById('select-all-bugs');
    const bugCheckboxes = document.querySelectorAll('.bug-checkbox');

    if (selectAllCheckbox.checked) {
        bugCheckboxes.forEach(checkbox => {
            selectedBugs.add(checkbox.value);
        });
    } else {
        selectedBugs.clear();
    }
    updateBugsDisplay();
}

function updateSelectionCount() {
    const count = selectedBugs.size;
    document.getElementById('bulk-assign-count').textContent = count;
    document.getElementById('bulk-update-count').textContent = count;
}

// Bulk operations
function showBulkAssignModal() {
    if (selectedBugs.size === 0) {
        AdminUtils.showToast('Please select bugs to assign', 'warning');
        return;
    }

    // Populate selected bugs list
    const bugList = document.getElementById('bulk-assign-bug-list');
    const selectedBugsList = Array.from(selectedBugs).map(bugId => {
        const bug = bugsData.find(b => b.bug_id === bugId);
        return bug ? `<small class="badge bg-light text-dark me-1">${bug.bug_id.substring(0, 8)}... - ${bug.title.substring(0, 30)}</small>` : '';
    }).join('');

    bugList.innerHTML = `<div class="text-muted mb-2">Selected bugs:</div><div>${selectedBugsList}</div>`;

    new bootstrap.Modal(document.getElementById('bulkAssignModal')).show();
}

function showBulkUpdateModal() {
    if (selectedBugs.size === 0) {
        AdminUtils.showToast('Please select bugs to update', 'warning');
        return;
    }

    // Populate selected bugs list
    const bugList = document.getElementById('bulk-update-bug-list');
    const selectedBugsList = Array.from(selectedBugs).map(bugId => {
        const bug = bugsData.find(b => b.bug_id === bugId);
        return bug ? `<small class="badge bg-light text-dark me-1">${bug.bug_id.substring(0, 8)}... - ${bug.title.substring(0, 30)}</small>` : '';
    }).join('');

    bugList.innerHTML = `<div class="text-muted mb-2">Selected bugs:</div><div>${selectedBugsList}</div>`;

    new bootstrap.Modal(document.getElementById('bulkUpdateModal')).show();
}

async function executeBulkAssign() {
    const assignee = document.getElementById('bulkAssignee').value.trim();
    if (!assignee) {
        AdminUtils.showToast('Please enter an assignee', 'warning');
        return;
    }

    try {
        const response = await fetch('/api/admin/testing/bugs/bulk-assign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                bug_ids: Array.from(selectedBugs),
                assignee: assignee,
                environment: currentEnvironment === 'all' ? 'dev' : currentEnvironment,
                assigned_by: 'admin'
            })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const result = await response.json();
        AdminUtils.showToast(`Assigned ${result.updated.length} bugs successfully`, 'success');

        bootstrap.Modal.getInstance(document.getElementById('bulkAssignModal')).hide();
        selectedBugs.clear();
        loadBugs();

    } catch (error) {
        console.error('Error in bulk assign:', error);
        AdminUtils.showToast('Failed to assign bugs', 'danger');
    }
}

async function executeBulkUpdate() {
    const updates = {};

    // Collect non-empty updates
    const status = document.getElementById('bulkStatus').value;
    const priority = document.getElementById('bulkPriority').value;
    const severity = document.getElementById('bulkSeverity').value;
    const component = document.getElementById('bulkComponent').value;
    const assignee = document.getElementById('bulkAssigneeUpdate').value.trim();

    if (status) updates.status = status;
    if (priority) updates.priority = priority;
    if (severity) updates.severity = severity;
    if (component) updates.component = component;
    if (assignee) updates.assigned_to = assignee;

    if (Object.keys(updates).length === 0) {
        AdminUtils.showToast('Please specify at least one update', 'warning');
        return;
    }

    updates.environment = currentEnvironment === 'all' ? 'dev' : currentEnvironment;

    try {
        const response = await fetch('/api/admin/testing/bugs/bulk-update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                bug_ids: Array.from(selectedBugs),
                updates: updates,
                updated_by: 'admin'
            })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const result = await response.json();
        AdminUtils.showToast(`Updated ${result.updated.length} bugs successfully`, 'success');

        bootstrap.Modal.getInstance(document.getElementById('bulkUpdateModal')).hide();
        selectedBugs.clear();
        loadBugs();

    } catch (error) {
        console.error('Error in bulk update:', error);
        AdminUtils.showToast('Failed to update bugs', 'danger');
    }
}

// Bug activity and analytics
async function viewBugActivity(bugId) {
    if (!bugId && currentBugId) {
        bugId = currentBugId;
    }

    try {
        const response = await fetch(`/api/admin/testing/bugs/${bugId}/activity?environment=${currentEnvironment === 'all' ? 'dev' : currentEnvironment}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();

        document.getElementById('activityModalTitle').textContent = `Bug Activity: ${bugId.substring(0, 8)}...`;

        const activityContent = document.getElementById('bug-activity-content');
        if (data.activity_log.length === 0) {
            activityContent.innerHTML = '<p class="text-muted">No activity recorded for this bug.</p>';
        } else {
            activityContent.innerHTML = data.activity_log.map(activity => {
                const timestamp = new Date(activity.timestamp * 1000).toLocaleString();
                return `
                    <div class="activity-item border-start border-3 ps-3 pb-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${activity.user}</strong>
                                <span class="text-muted"> ${activity.activity_type}</span>
                            </div>
                            <small class="text-muted">${timestamp}</small>
                        </div>
                        <div class="mt-1">${activity.description}</div>
                        ${activity.details ? `<small class="text-muted">Details: ${JSON.stringify(activity.details)}</small>` : ''}
                    </div>
                `;
            }).join('');
        }

        new bootstrap.Modal(document.getElementById('bugActivityModal')).show();

    } catch (error) {
        console.error('Error loading bug activity:', error);
        AdminUtils.showToast('Failed to load bug activity', 'danger');
    }
}

async function showBugAnalytics() {
    try {
        const env = currentEnvironment === 'all' ? 'dev' : currentEnvironment;
        const response = await fetch(`/api/admin/testing/bugs/analytics/${env}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const analytics = await response.json();

        const content = document.getElementById('bug-analytics-content');
        content.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-primary">${analytics.total_bugs}</h3>
                            <small class="text-muted">Total Bugs</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-success">${analytics.resolution_rate_percent}%</h3>
                            <small class="text-muted">Resolution Rate</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="text-info">${analytics.timing_metrics.avg_resolution_time_hours}h</h3>
                            <small class="text-muted">Avg Resolution Time</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <h5>Status Distribution</h5>
                    <div class="chart-container">
                        ${Object.entries(analytics.distributions.status).map(([status, count]) => `
                            <div class="d-flex justify-content-between">
                                <span>${status.replace('_', ' ')}</span>
                                <span class="badge bg-secondary">${count}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="col-md-6">
                    <h5>Priority Distribution</h5>
                    <div class="chart-container">
                        ${Object.entries(analytics.distributions.priority).map(([priority, count]) => `
                            <div class="d-flex justify-content-between">
                                <span>${priority}</span>
                                <span class="badge bg-secondary">${count}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        new bootstrap.Modal(document.getElementById('bugAnalyticsModal')).show();

    } catch (error) {
        console.error('Error loading bug analytics:', error);
        AdminUtils.showToast('Failed to load bug analytics', 'danger');
    }
}

// Utility functions
async function refreshTestingData() {
    await loadTestingData();
}

async function refreshTests() {
    AdminUtils.showToast('Refreshing tests...', 'info');
    await loadTests();
    AdminUtils.showToast('Tests refreshed', 'success');
}

async function refreshBugs() {
    AdminUtils.showToast('Refreshing bugs...', 'info');
    await loadBugs();
    AdminUtils.showToast('Bugs refreshed', 'success');
}

async function loadExecutionHistory() {
    try {
        const response = await fetch('/api/admin/testing/execution-history');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const history = await response.json();
        updateExecutionHistory(history);
    } catch (error) {
        console.error('Error loading execution history:', error);
        document.getElementById('execution-history').innerHTML = `
            <div class="text-center text-danger">
                <i class="bi bi-exclamation-triangle"></i>
                Failed to load execution history
            </div>
        `;
    }
}

function updateExecutionHistory(history) {
    const container = document.getElementById('execution-history');

    if (history.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="bi bi-clock-history display-4 mb-2"></i>
                <p>No test execution history found.</p>
            </div>
        `;
        return;
    }

    container.innerHTML = history.map(execution => {
        const startTime = new Date(execution.started_at * 1000).toLocaleString();
        const duration = execution.duration_seconds ? `${execution.duration_seconds.toFixed(2)}s` : '--';
        const statusClass = `status-${execution.status}`;

        return `
            <div class="execution-item ${statusClass}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Execution ${execution.execution_id.substring(0, 8)}...</strong>
                        <span class="ms-2 badge bg-info">${execution.environment}</span>
                    </div>
                    <div class="text-end">
                        <div><strong>Status:</strong> <span class="test-status-badge test-status-${execution.status}">${execution.status}</span></div>
                        <div><strong>Duration:</strong> ${duration}</div>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">Started: ${startTime}</small>
                </div>
                ${execution.stderr ? `
                <div class="mt-2">
                    <small><strong>Error:</strong></small>
                    <div class="test-output" style="max-height: 100px;">${execution.stderr}</div>
                </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

async function exportTestResults() {
    try {
        AdminUtils.showToast('Preparing test results export...', 'info');

        const response = await fetch('/api/admin/testing/export-results');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `test-results-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        AdminUtils.showToast('Test results exported successfully', 'success');

    } catch (error) {
        console.error('Error exporting test results:', error);
        AdminUtils.showToast('Failed to export test results', 'danger');
    }
}

async function stopAllTests() {
    if (!confirm('Stop all running tests?')) return;

    try {
        const response = await fetch('/api/admin/testing/stop-all', { method: 'POST' });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        AdminUtils.showToast('All tests stopped', 'warning');
        updateTestExecutionStatus('ready', 'Ready');

        // Clean up any active test executions from our tracking
        activeTestExecutions.clear();

    } catch (error) {
        console.error('Error stopping tests:', error);
        AdminUtils.showToast('Failed to stop tests', 'danger');
    }
}
</script>
{% endblock %}