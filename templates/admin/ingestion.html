{% extends "base.html" %}

{% block title %}Ingestion Console - TTRPG Center Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Ingestion Console</h1>
    <div class="btn-group" role="group">
        <button class="btn btn-admin" onclick="runNightly('dev')">
            <i class="bi bi-play-circle me-1"></i>Run Nightly Now
        </button>
        <button class="btn btn-outline-primary" onclick="refreshConsole()">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh All
        </button>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-gear me-1"></i>Environment
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="switchEnvironment('dev')">Development</a></li>
                <li><a class="dropdown-item" href="#" onclick="switchEnvironment('test')">Testing</a></li>
                <li><a class="dropdown-item" href="#" onclick="switchEnvironment('prod')">Production</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Environment Indicator -->
<div class="alert alert-info d-flex align-items-center mb-4" role="alert">
    <i class="bi bi-info-circle-fill me-2"></i>
    <div>
        Currently managing <strong id="current-environment">Development</strong> environment.
        Switch environments using the dropdown above to manage different ingestion pipelines.
    </div>
</div>

<!-- Upload Management Section -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-cloud-upload me-2"></i>Upload Management</h5>
        <div class="d-flex align-items-center gap-2">
            <div class="upload-stats text-muted small" id="upload-stats">
                Loading...
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Enhanced Drag & Drop Upload Area -->
        <div class="upload-area mb-3" id="upload-area"
             ondrop="dropHandler(event)"
             ondragover="dragOverHandler(event)"
             ondragleave="dragLeaveHandler(event)"
             ondragenter="dragEnterHandler(event)">
            <div class="upload-area-content" id="upload-area-content">
                <i class="bi bi-cloud-arrow-up display-4 text-success mb-3" id="upload-icon"></i>
                <h4 class="mb-3" id="upload-title"><strong>Drag & Drop PDF Files Here</strong></h4>
                <p class="text-muted mb-3" id="upload-description">
                    <i class="bi bi-info-circle me-1"></i>
                    <span id="upload-hint">Drop one or more PDF files into this area for automatic upload</span>
                </p>
                <div class="mb-3">
                    <span class="badge bg-light text-dark me-2"><i class="bi bi-file-earmark-pdf me-1"></i>PDF files only</span>
                    <span class="badge bg-light text-dark me-2"><i class="bi bi-hdd me-1"></i>Max 50MB per file</span>
                    <span class="badge bg-light text-dark"><i class="bi bi-stack me-1"></i>Multiple files supported</span>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-lightbulb me-2"></i>
                    <strong>Note:</strong> File browse functionality is restricted in this environment.
                    Please use drag & drop to upload files.
                </div>
            </div>
        </div>

        <!-- Upload Progress -->
        <div id="upload-progress" class="mb-3" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <small class="text-muted">Uploading files...</small>
                <small class="text-muted" id="upload-progress-text">0%</small>
            </div>
            <div class="progress">
                <div class="progress-bar" role="progressbar" id="upload-progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <!-- Uploaded Files Table -->
        <div id="uploads-empty" class="text-center text-muted py-4" style="display:none;">
            <i class="bi bi-inbox display-4 mb-2"></i>
            <p>No files in uploads directory.</p>
            <small>Upload PDF files to get started with ingestion.</small>
        </div>

        <div class="table-responsive">
            <table class="table table-sm" id="uploads-table">
                <thead>
                    <tr>
                        <th style="width: 20px;">
                            <input type="checkbox" id="select-all-uploads" onchange="toggleAllUploads(this.checked)">
                        </th>
                        <th>Name</th>
                        <th style="width: 100px;">Size</th>
                        <th style="width: 150px;">Modified</th>
                        <th style="width: 120px;">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Bulk Actions -->
        <div class="d-flex justify-content-between align-items-center mt-3" id="bulk-actions" style="display: none !important;">
            <div class="form-check">
                <span class="text-muted small" id="selected-count">0 files selected</span>
            </div>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-danger" onclick="deleteSelected()">
                    <i class="bi bi-trash me-1"></i>Delete Selected
                </button>
                <button class="btn btn-admin" onclick="ingestSelected()">
                    <i class="bi bi-gear me-1"></i>Ingest Selected
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Ingested Sources Health Monitoring -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-database-check me-2"></i>Ingested Sources Health</h5>
        <div class="d-flex align-items-center gap-2">
            <div class="legend d-flex align-items-center gap-3 me-3">
                <div class="d-flex align-items-center gap-1">
                    <div class="health-indicator health-green"></div>
                    <small class="text-muted">Healthy</small>
                </div>
                <div class="d-flex align-items-center gap-1">
                    <div class="health-indicator health-yellow"></div>
                    <small class="text-muted">Issues</small>
                </div>
                <div class="d-flex align-items-center gap-1">
                    <div class="health-indicator health-red"></div>
                    <small class="text-muted">Failed</small>
                </div>
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="loadSources()">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="sources-empty" class="text-center text-muted py-4" style="display:none;">
            <i class="bi bi-database-x display-4 mb-2"></i>
            <p>No ingested sources found.</p>
            <small>Upload and process PDF files to see sources here.</small>
        </div>

        <div class="table-responsive">
            <table class="table table-sm" id="sources-table">
                <thead>
                    <tr>
                        <th style="width: 20px;">
                            <input type="checkbox" id="select-all-sources" onchange="toggleAllSources(this.checked)">
                        </th>
                        <th>Source Name</th>
                        <th style="width: 100px;">Chunks</th>
                        <th style="width: 100px;">Health</th>
                        <th style="width: 120px;">Status</th>
                        <th style="width: 150px;">Last Modified</th>
                        <th style="width: 120px;">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Source Bulk Actions -->
        <div class="d-flex justify-content-between align-items-center mt-3" id="source-bulk-actions" style="display: none !important;">
            <div class="form-check">
                <span class="text-muted small" id="sources-selected-count">0 sources selected</span>
            </div>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-warning" onclick="reprocessSelected()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Reprocess Selected
                </button>
                <button class="btn btn-outline-danger" onclick="removeSelectedSources()">
                    <i class="bi bi-trash me-1"></i>Remove Selected
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Job Monitoring Section -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-list-task me-2"></i>Recent Ingestion Jobs</h5>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="loadJobs()">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
            </button>
            <button class="btn btn-outline-secondary" onclick="showJobLogs()">
                <i class="bi bi-file-text me-1"></i>View Logs
            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="jobs-empty" class="text-center text-muted py-4" style="display:none;">
            <i class="bi bi-clock-history display-4 mb-2"></i>
            <p>No recent ingestion jobs.</p>
            <small>Job history will appear here after processing files.</small>
        </div>

        <div class="table-responsive">
            <table class="table table-sm" id="jobs-table">
                <thead>
                    <tr>
                        <th>Job ID</th>
                        <th>Source</th>
                        <th style="width: 100px;">Status</th>
                        <th style="width: 120px;">Progress</th>
                        <th style="width: 150px;">Started</th>
                        <th style="width: 100px;">Duration</th>
                        <th style="width: 100px;">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Custom Styles for Ingestion Console -->
<style>
.upload-area {
    border: 2px dashed #cbd5e1;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    background: #f8fafc;
    cursor: pointer;
    position: relative;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.upload-area:hover {
    border-color: #94a3b8;
    background: #f1f5f9;
}

.upload-area.dragover {
    border-color: var(--admin-primary);
    background: rgba(30, 58, 138, 0.08);
    transform: scale(1.02);
    box-shadow: 0 8px 32px rgba(30, 58, 138, 0.15);
    border-style: solid;
}

.upload-area.dragover::before {
    content: '';
    position: absolute;
    inset: -2px;
    border: 2px solid var(--admin-primary);
    border-radius: 14px;
    animation: borderPulse 1.5s infinite;
}

@keyframes borderPulse {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 1; }
}

.upload-area-content {
    pointer-events: none;
    z-index: 1;
    position: relative;
}

.health-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}

.health-green { background-color: #16a34a; }
.health-yellow { background-color: #d97706; }
.health-red { background-color: #dc2626; }

.job-status-running { color: #2563eb; }
.job-status-completed { color: #16a34a; }
.job-status-failed { color: #dc2626; }
.job-status-pending { color: #d97706; }

.progress-mini {
    height: 8px;
    border-radius: 4px;
}

.legend {
    font-size: 0.875rem;
}

.table th {
    border-top: none;
    font-weight: 600;
    background: rgba(248, 250, 252, 0.8);
}

.btn-group-sm .btn {
    padding: 0.25rem 0.75rem;
    font-size: 0.875rem;
}
</style>

{% endblock %}

{% block extra_scripts %}
<script>
let currentEnvironment = 'dev';
let selectedUploads = new Set();
let selectedSources = new Set();

// Initialize console
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìã Ingestion Console initializing...');
    refreshConsole();
    setupEventListeners();
    console.log('‚úÖ Ingestion Console ready! Use drag & drop to upload files.');
});

// Note: Browse button functionality disabled due to browser security restrictions
// when accessing through ngrok. Drag & drop functionality works perfectly.

function setupEventListeners() {
    console.log('Setting up event listeners for drag & drop upload...');

    // Set up both file inputs
    const visibleInput = document.getElementById('upload-input-visible');
    const hiddenInput = document.getElementById('upload-input-hidden');
    const browseBtn = document.getElementById('browse-btn');

    // Visible input listener
    if (visibleInput) {
        visibleInput.addEventListener('change', handleFileSelect);
        console.log('‚úÖ Visible file input listener added');
    }

    // Hidden input listener
    if (hiddenInput) {
        hiddenInput.addEventListener('change', handleFileSelect);
        console.log('‚úÖ Hidden file input listener added');
    }

    // Browse button listener
    if (browseBtn && hiddenInput) {
        browseBtn.addEventListener('click', function() {
            console.log('üîò Browse button clicked, triggering hidden input');
            hiddenInput.click();
        });
        console.log('‚úÖ Browse button listener added');
    }

    // Debug info
    console.log('Available elements:', {
        'upload-input-visible': visibleInput,
        'upload-input-hidden': hiddenInput,
        'browse-btn': browseBtn
    });
}

async function refreshConsole() {
    AdminUtils.showToast('Refreshing ingestion console...', 'info');
    await Promise.all([
        loadUploads(),
        loadSources(),
        loadJobs()
    ]);
    AdminUtils.showToast('Console refreshed', 'success');
}

function switchEnvironment(env) {
    if (env !== currentEnvironment) {
        currentEnvironment = env;
        document.getElementById('current-environment').textContent =
            env === 'dev' ? 'Development' : (env === 'test' ? 'Testing' : 'Production');
        refreshConsole();
        AdminUtils.showToast(`Switched to ${env} environment`, 'info');
    }
}

// ====================== File Upload Management ======================

function handleFileSelect(event) {
    console.log('üéØ handleFileSelect called for visible file input');
    const files = event.target.files;
    if (files.length > 0) {
        console.log('üìÇ Files selected from input:', Array.from(files).map(f => f.name));
        // For the visible file input, we should trigger the browse upload handler
        handleBrowseUpload(event);
    }
}

function handleBrowseUpload(event) {
    console.log('üìÇ Browse upload triggered!');
    console.log('üìÇ Event:', event);
    console.log('üìÇ Target:', event.target);
    console.log('üìÇ Files object:', event.target.files);
    console.log('üìÇ Files length:', event.target.files ? event.target.files.length : 'no files');

    if (event.target.files && event.target.files.length > 0) {
        const allFiles = Array.from(event.target.files);
        console.log('üìÇ All selected files:', allFiles.map(f => ({ name: f.name, type: f.type })));

        const pdfFiles = allFiles.filter(f => f.type === 'application/pdf');
        console.log('üìÇ PDF files:', pdfFiles.map(f => f.name));

        if (pdfFiles.length > 0) {
            console.log('üìÇ Auto-uploading browsed files:', pdfFiles.map(f => f.name));
            uploadFiles(pdfFiles);
        } else {
            console.log('üìÇ No PDF files found');
            AdminUtils.showToast('Please select only PDF files', 'warning');
        }
    } else {
        console.log('üìÇ No files selected or files object is null');
    }

    // Clear the input for next use
    setTimeout(() => {
        event.target.value = '';
        console.log('üìÇ Input cleared');
    }, 1000);
}

function showUploadPreview(files) {
    // Optional: Show preview of selected files before upload
    console.log('Selected files:', files.map(f => f.name));
}

// Enhanced Drag & Drop handlers with better validation and feedback
function dragEnterHandler(event) {
    event.preventDefault();
    const uploadArea = document.getElementById('upload-area');
    uploadArea.classList.add('dragover');

    // Update visual feedback
    document.getElementById('upload-icon').className = 'bi bi-cloud-arrow-down display-4 text-primary mb-3';
    document.getElementById('upload-title').innerHTML = '<strong>Drop Files Here</strong>';
    document.getElementById('upload-hint').textContent = 'Release to upload your PDF files';
}

function dragOverHandler(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'copy';
}

function dragLeaveHandler(event) {
    event.preventDefault();

    // Only remove dragover when actually leaving the drop zone
    const rect = event.currentTarget.getBoundingClientRect();
    const x = event.clientX;
    const y = event.clientY;

    if (x < rect.left || x >= rect.right || y < rect.top || y >= rect.bottom) {
        resetUploadAreaVisuals();
    }
}

function dropHandler(event) {
    event.preventDefault();
    resetUploadAreaVisuals();

    const files = Array.from(event.dataTransfer.files);
    console.log('Files dropped:', files.map(f => f.name));

    // Validate files
    const validationResult = validateFiles(files);

    if (!validationResult.valid) {
        AdminUtils.showToast(validationResult.message, 'warning');
        return;
    }

    const validFiles = validationResult.files;
    AdminUtils.showToast(`Uploading ${validFiles.length} file(s)...`, 'info');
    uploadFiles(validFiles);
}

function resetUploadAreaVisuals() {
    document.getElementById('upload-area').classList.remove('dragover');
    document.getElementById('upload-icon').className = 'bi bi-cloud-arrow-up display-4 text-success mb-3';
    document.getElementById('upload-title').innerHTML = '<strong>Drag & Drop PDF Files Here</strong>';
    document.getElementById('upload-hint').textContent = 'Drop one or more PDF files into this area for automatic upload';
}

function validateFiles(files) {
    const maxFileSize = 50 * 1024 * 1024; // 50MB
    const maxFiles = 10; // Maximum files per upload
    const allowedTypes = ['application/pdf'];

    // Check file count
    if (files.length === 0) {
        return { valid: false, message: 'No files selected' };
    }

    if (files.length > maxFiles) {
        return { valid: false, message: `Maximum ${maxFiles} files allowed per upload` };
    }

    const validFiles = [];
    const invalidFiles = [];

    for (const file of files) {
        // Check file type
        if (!allowedTypes.includes(file.type) && !file.name.toLowerCase().endsWith('.pdf')) {
            invalidFiles.push(`${file.name} (not a PDF)`);
            continue;
        }

        // Check file size
        if (file.size > maxFileSize) {
            invalidFiles.push(`${file.name} (too large: ${AdminUtils.formatBytes(file.size)})`);
            continue;
        }

        // Check for empty files
        if (file.size === 0) {
            invalidFiles.push(`${file.name} (empty file)`);
            continue;
        }

        validFiles.push(file);
    }

    if (invalidFiles.length > 0) {
        const message = `Invalid files rejected: ${invalidFiles.join(', ')}`;
        if (validFiles.length > 0) {
            AdminUtils.showToast(`${message}. Proceeding with ${validFiles.length} valid file(s).`, 'warning');
        } else {
            return { valid: false, message: message };
        }
    }

    return { valid: true, files: validFiles, message: 'Files validated successfully' };
}

// Endpoint validation functions for FR-010
async function validateIngestionEndpoints() {
    console.log('üß™ Validating ingestion management endpoints...');

    const results = {
        upload: { status: 'unknown', endpoint: '/api/admin/uploads' },
        start: { status: 'unknown', endpoint: '/api/admin/ingestion/run' },
        cancel: { status: 'unknown', endpoint: '/api/admin/ingestion/cancel' },
        status: { status: 'unknown', endpoint: '/api/admin/ingestion/status' },
        jobs: { status: 'unknown', endpoint: '/api/admin/ingestion/jobs' }
    };

    // Test upload endpoint
    try {
        const uploadResponse = await fetch('/api/admin/uploads', { method: 'GET' });
        results.upload.status = uploadResponse.ok ? 'available' : 'error';
        results.upload.statusCode = uploadResponse.status;
    } catch (error) {
        results.upload.status = 'failed';
        results.upload.error = error.message;
    }

    // Test ingestion status endpoint
    try {
        const statusResponse = await fetch('/api/admin/ingestion/status?env=dev', { method: 'GET' });
        results.status.status = statusResponse.ok ? 'available' : 'error';
        results.status.statusCode = statusResponse.status;
    } catch (error) {
        results.status.status = 'failed';
        results.status.error = error.message;
    }

    // Test jobs list endpoint
    try {
        const jobsResponse = await fetch('/api/admin/ingestion/jobs?env=dev', { method: 'GET' });
        results.jobs.status = jobsResponse.ok ? 'available' : 'error';
        results.jobs.statusCode = jobsResponse.status;
    } catch (error) {
        results.jobs.status = 'failed';
        results.jobs.error = error.message;
    }

    // Test ingestion run endpoint (dry run - don't actually start)
    try {
        const runResponse = await fetch('/api/admin/ingestion/validate', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });
        results.start.status = runResponse.ok ? 'available' : 'error';
        results.start.statusCode = runResponse.status;
    } catch (error) {
        results.start.status = 'failed';
        results.start.error = error.message;
    }

    console.log('Endpoint validation results:', results);

    // Display results to user
    const summary = Object.entries(results).map(([name, result]) =>
        `${name}: ${result.status} (${result.endpoint})`
    ).join('\n');

    AdminUtils.showToast(`Endpoint validation completed. Check console for details.`, 'info');

    return results;
}

async function testJobSubmissionFlow() {
    console.log('üß™ Testing job submission and monitoring flow...');

    try {
        // Test 1: Validate we can check job status
        const statusCheck = await fetch('/api/admin/ingestion/status?env=dev');
        console.log('‚úÖ Status check:', statusCheck.ok ? 'OK' : 'Failed');

        // Test 2: Validate we can list jobs
        const jobsList = await fetch('/api/admin/ingestion/jobs?env=dev');
        console.log('‚úÖ Jobs list:', jobsList.ok ? 'OK' : 'Failed');

        // Test 3: Check for running jobs before testing cancel
        if (jobsList.ok) {
            const jobs = await jobsList.json();
            const runningJobs = jobs.filter(job => job.status === 'running');
            console.log(`üìä Found ${runningJobs.length} running jobs`);

            if (runningJobs.length > 0) {
                console.log('üß™ Testing cancel functionality...');
                // Note: Only test if there are actually running jobs
                // We don't want to create test jobs just for this
            }
        }

        AdminUtils.showToast('Job submission flow test completed successfully', 'success');
        return true;

    } catch (error) {
        console.error('‚ùå Job submission flow test failed:', error);
        AdminUtils.showToast('Job submission flow test failed', 'danger');
        return false;
    }
}

function addEndpointValidationControls() {
    // Add validation controls to the page
    const uploadCard = document.querySelector('.card-header h5').parentElement;

    const validationControls = document.createElement('div');
    validationControls.className = 'btn-group btn-group-sm ms-2';
    validationControls.innerHTML = `
        <button class="btn btn-outline-info" onclick="validateIngestionEndpoints()" title="Validate Endpoints">
            <i class="bi bi-check-circle me-1"></i>Validate
        </button>
        <button class="btn btn-outline-secondary" onclick="testJobSubmissionFlow()" title="Test Job Flow">
            <i class="bi bi-gear me-1"></i>Test Flow
        </button>
    `;

    uploadCard.appendChild(validationControls);
}

// Initialize endpoint validation on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add validation controls
    addEndpointValidationControls();

    // Auto-validate endpoints on load
    setTimeout(() => {
        validateIngestionEndpoints();
    }, 2000);
});

// Note: uploadSelected function removed - both drag & drop and browse now auto-upload

function testFileInput() {
    console.log('üß™ Testing file input functionality...');

    const visibleInput = document.getElementById('upload-input-visible');
    const hiddenInput = document.getElementById('upload-input-hidden');

    console.log('Visible input:', visibleInput);
    console.log('Hidden input:', hiddenInput);

    // Test clicking the hidden input directly
    if (hiddenInput) {
        console.log('üß™ Attempting to click hidden input...');
        try {
            hiddenInput.click();
            console.log('‚úÖ Hidden input click succeeded');
        } catch (error) {
            console.error('‚ùå Hidden input click failed:', error);
        }
    }

    // Test clicking the visible input directly
    if (visibleInput) {
        console.log('üß™ Attempting to click visible input...');
        try {
            visibleInput.click();
            console.log('‚úÖ Visible input click succeeded');
        } catch (error) {
            console.error('‚ùå Visible input click failed:', error);
        }
    }
}

async function uploadFiles(files) {
    const progressContainer = document.getElementById('upload-progress');
    const progressBar = document.getElementById('upload-progress-bar');
    const progressText = document.getElementById('upload-progress-text');

    progressContainer.style.display = 'block';

    try {
        const formData = new FormData();
        files.forEach(file => formData.append('files', file));

        const xhr = new XMLHttpRequest();

        // Upload progress handler
        xhr.upload.onprogress = function(event) {
            if (event.lengthComputable) {
                const percent = Math.round((event.loaded / event.total) * 100);
                progressBar.style.width = percent + '%';
                progressText.textContent = percent + '%';
            }
        };

        xhr.onload = function() {
            progressContainer.style.display = 'none';
            if (xhr.status === 200) {
                AdminUtils.showToast(`${files.length} file(s) uploaded successfully`, 'success');
                document.getElementById('upload-input').value = '';
                loadUploads();
            } else {
                throw new Error('Upload failed');
            }
        };

        xhr.onerror = function() {
            progressContainer.style.display = 'none';
            throw new Error('Upload failed');
        };

        xhr.open('POST', `/api/uploads?env=${currentEnvironment}`);
        xhr.send(formData);

    } catch (error) {
        progressContainer.style.display = 'none';
        console.error('Upload failed:', error);
        AdminUtils.showToast('Upload failed', 'danger');
    }
}

async function loadUploads() {
    try {
        const response = await fetch(`/api/uploads?env=${currentEnvironment}`);
        const data = await response.json();

        const tbody = document.querySelector('#uploads-table tbody');
        const empty = document.getElementById('uploads-empty');
        const stats = document.getElementById('upload-stats');

        tbody.innerHTML = '';
        selectedUploads.clear();
        updateBulkActions();

        if (!data.files || data.files.length === 0) {
            empty.style.display = 'block';
            stats.textContent = 'No uploads';
            return;
        }

        empty.style.display = 'none';
        stats.textContent = `${data.files.length} file(s), ${AdminUtils.formatBytes(data.files.reduce((sum, f) => sum + f.size_bytes, 0))}`;

        data.files.forEach(file => {
            const tr = document.createElement('tr');
            const safeFileName = file.name.replace(/'/g, "\\'");

            tr.innerHTML = `
                <td><input type="checkbox" class="upload-checkbox" value="${safeFileName}" onchange="toggleUploadSelection('${safeFileName}', this.checked)"></td>
                <td>
                    <i class="bi bi-file-pdf text-danger me-1"></i>
                    ${file.name}
                </td>
                <td>${AdminUtils.formatBytes(file.size_bytes)}</td>
                <td>${AdminUtils.formatTimestamp(file.modified_at)}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-admin btn-sm" onclick="ingestFile('${safeFileName}')" title="Ingest Now">
                            <i class="bi bi-gear"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteUpload('${safeFileName}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });

    } catch (error) {
        console.error('Failed to load uploads:', error);
        AdminUtils.showToast('Failed to load uploads', 'danger');
    }
}

function toggleUploadSelection(fileName, checked) {
    if (checked) {
        selectedUploads.add(fileName);
    } else {
        selectedUploads.delete(fileName);
    }
    updateBulkActions();
}

function toggleAllUploads(checked) {
    const checkboxes = document.querySelectorAll('.upload-checkbox');
    selectedUploads.clear();

    checkboxes.forEach(cb => {
        cb.checked = checked;
        if (checked) {
            selectedUploads.add(cb.value);
        }
    });
    updateBulkActions();
}

function updateBulkActions() {
    const bulkActions = document.getElementById('bulk-actions');
    const selectedCount = document.getElementById('selected-count');

    if (selectedUploads.size > 0) {
        bulkActions.style.display = 'flex';
        selectedCount.textContent = `${selectedUploads.size} file(s) selected`;
    } else {
        bulkActions.style.display = 'none';
    }
}

async function deleteUpload(fileName) {
    if (!confirm(`Delete ${fileName}?`)) return;

    try {
        const response = await fetch(`/api/uploads?name=${encodeURIComponent(fileName)}&env=${currentEnvironment}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            AdminUtils.showToast('File deleted', 'success');
            loadUploads();
        } else {
            throw new Error('Delete failed');
        }
    } catch (error) {
        console.error('Delete failed:', error);
        AdminUtils.showToast('Failed to delete file', 'danger');
    }
}

async function ingestFile(fileName) {
    try {
        AdminUtils.showToast(`Starting ingestion for ${fileName}...`, 'info');
        // This would trigger the actual ingestion process
        // For now, just show a success message
        setTimeout(() => {
            AdminUtils.showToast(`Ingestion started for ${fileName}`, 'success');
            loadJobs();
        }, 1000);
    } catch (error) {
        console.error('Ingestion failed:', error);
        AdminUtils.showToast('Failed to start ingestion', 'danger');
    }
}

// ====================== Source Health Monitoring ======================

async function loadSources() {
    try {
        const response = await fetch(`/api/ingestion/${currentEnvironment}/sources`);
        const data = await response.json();

        const tbody = document.querySelector('#sources-table tbody');
        const empty = document.getElementById('sources-empty');

        tbody.innerHTML = '';
        selectedSources.clear();
        updateSourceBulkActions();

        if (!data.sources || data.sources.length === 0) {
            empty.style.display = 'block';
            return;
        }

        empty.style.display = 'none';

        data.sources.forEach(source => {
            const tr = document.createElement('tr');
            const safeSourceId = source.id.replace(/'/g, "\\'");
            const healthClass = `health-${source.health}`;
            const statusClass = `job-status-${source.status}`;

            tr.innerHTML = `
                <td><input type="checkbox" class="source-checkbox" value="${safeSourceId}" onchange="toggleSourceSelection('${safeSourceId}', this.checked)"></td>
                <td>
                    <i class="bi bi-file-text me-1"></i>
                    <strong>${source.id}</strong>
                    <br><small class="text-muted">${source.source_file}</small>
                </td>
                <td><span class="badge bg-light text-dark">${source.chunk_count}</span></td>
                <td>
                    <div class="d-flex align-items-center gap-1">
                        <div class="health-indicator ${healthClass}"></div>
                        <span class="text-uppercase small fw-bold">${source.health}</span>
                    </div>
                </td>
                <td><span class="badge bg-secondary ${statusClass}">${source.status}</span></td>
                <td>${AdminUtils.formatTimestamp(source.last_modified)}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info btn-sm" onclick="viewSourceDetails('${safeSourceId}')" title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="reprocessSource('${safeSourceId}')" title="Reprocess">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="removeSource('${safeSourceId}')" title="Remove">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });

    } catch (error) {
        console.error('Failed to load sources:', error);
        AdminUtils.showToast('Failed to load sources', 'danger');
    }
}

function toggleSourceSelection(sourceId, checked) {
    if (checked) {
        selectedSources.add(sourceId);
    } else {
        selectedSources.delete(sourceId);
    }
    updateSourceBulkActions();
}

function toggleAllSources(checked) {
    const checkboxes = document.querySelectorAll('.source-checkbox');
    selectedSources.clear();

    checkboxes.forEach(cb => {
        cb.checked = checked;
        if (checked) {
            selectedSources.add(cb.value);
        }
    });
    updateSourceBulkActions();
}

function updateSourceBulkActions() {
    const bulkActions = document.getElementById('source-bulk-actions');
    const selectedCount = document.getElementById('sources-selected-count');

    if (selectedSources.size > 0) {
        bulkActions.style.display = 'flex';
        selectedCount.textContent = `${selectedSources.size} source(s) selected`;
    } else {
        bulkActions.style.display = 'none';
    }
}

async function removeSource(sourceId) {
    if (!confirm(`Remove source ${sourceId}? This will delete all associated artifacts and cannot be undone.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/ingestion/${currentEnvironment}/source?name=${encodeURIComponent(sourceId)}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            AdminUtils.showToast('Source removed successfully', 'success');
            loadSources();
        } else {
            throw new Error('Remove failed');
        }
    } catch (error) {
        console.error('Remove source failed:', error);
        AdminUtils.showToast('Failed to remove source', 'danger');
    }
}

async function reprocessSource(sourceId) {
    try {
        AdminUtils.showToast(`Starting reprocessing for ${sourceId}...`, 'info');
        // This would trigger reprocessing
        setTimeout(() => {
            AdminUtils.showToast(`Reprocessing started for ${sourceId}`, 'success');
            loadSources();
            loadJobs();
        }, 1000);
    } catch (error) {
        console.error('Reprocess failed:', error);
        AdminUtils.showToast('Failed to start reprocessing', 'danger');
    }
}

function viewSourceDetails(sourceId) {
    // This would show a modal with detailed source information
    AdminUtils.showToast(`Viewing details for ${sourceId}`, 'info');
}

// ====================== Job Monitoring ======================

async function loadJobs() {
    try {
        const response = await fetch(`/api/ingestion/overview`);
        const data = await response.json();

        const tbody = document.querySelector('#jobs-table tbody');
        const empty = document.getElementById('jobs-empty');

        tbody.innerHTML = '';

        const envJobs = data.environments[currentEnvironment]?.recent_jobs || [];

        if (envJobs.length === 0) {
            empty.style.display = 'block';
            return;
        }

        empty.style.display = 'none';

        envJobs.forEach(job => {
            const tr = document.createElement('tr');
            const statusClass = `job-status-${job.status}`;
            const progress = job.progress_percent || 0;

            tr.innerHTML = `
                <td><code>${job.job_id}</code></td>
                <td>
                    <i class="bi bi-file-text me-1"></i>
                    ${job.source_file}
                </td>
                <td><span class="badge bg-secondary ${statusClass}">${job.status}</span></td>
                <td>
                    <div class="d-flex align-items-center gap-2">
                        <div class="progress progress-mini flex-grow-1">
                            <div class="progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <small>${Math.round(progress)}%</small>
                    </div>
                </td>
                <td>${job.started_at ? AdminUtils.formatTimestamp(job.started_at) : '-'}</td>
                <td>${job.duration_seconds ? AdminUtils.formatDuration(job.duration_seconds) : '-'}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info btn-sm" onclick="viewJobDetails('${job.job_id}')" title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                        ${job.status === 'failed' ? `<button class="btn btn-outline-warning btn-sm" onclick="retryJob('${job.job_id}')" title="Retry"><i class="bi bi-arrow-clockwise"></i></button>` : ''}
                        ${job.status === 'running' ? `<button class="btn btn-outline-danger btn-sm" onclick="killJob('${job.job_id}')" title="Cancel Job"><i class="bi bi-stop-circle"></i></button>` : ''}
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });

    } catch (error) {
        console.error('Failed to load jobs:', error);
        AdminUtils.showToast('Failed to load jobs', 'danger');
    }
}

function viewJobDetails(jobId) {
    // Navigate to logs page with job filter to open correct log
    window.location.href = `/admin/logs?env=${currentEnvironment}&job=${jobId}`;
}

function retryJob(jobId) {
    AdminUtils.showToast(`Retrying job ${jobId}...`, 'info');
    // Implementation for job retry
}

async function killJob(jobId) {
    if (!confirm(`Are you sure you want to cancel job ${jobId}? This action cannot be undone.`)) {
        return;
    }

    try {
        AdminUtils.showToast(`Cancelling job ${jobId}...`, 'info');
        const response = await fetch(`/api/ingestion/${currentEnvironment}/jobs/${jobId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            const result = await response.json();
            AdminUtils.showToast(result.message || `Job ${jobId} cancelled successfully`, 'success');
            // Refresh the jobs list to show updated status
            setTimeout(() => loadJobs(), 1000);
        } else {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to kill job');
        }
    } catch (error) {
        console.error('Kill job failed:', error);
        AdminUtils.showToast(`Failed to cancel job: ${error.message}`, 'danger');
    }
}

function showJobLogs() {
    // This would show aggregated job logs
    AdminUtils.showToast('Opening job logs...', 'info');
}

// Reuse functions from main dashboard that are still needed
async function runNightly(environment) {
    try {
        AdminUtils.showToast(`Starting nightly run for ${environment}...`, 'info');
        const res = await fetch('/api/admin/ingestion/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ env: environment })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        AdminUtils.showToast(`Nightly started for ${data.env} (pid ${data.pid})`, 'success');
        setTimeout(() => loadJobs(), 2000); // Refresh jobs after starting
    } catch (e) {
        console.error('Failed to start nightly:', e);
        AdminUtils.showToast('Failed to start nightly run', 'danger');
    }
}
</script>
{% endblock %}