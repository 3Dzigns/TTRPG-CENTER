# BUG-027 — Critical Blockers: Stub LLM Path & Failing Test Suite (Py3.12/Cassandra)

**Severity:** P1 (blocks onboarding, CI, and truthful behavior)  
**Owner:** Orchestrator & Vector Store maintainers  
**Reported:** 2025‑09‑18 (America/Chicago)  
**Environments:** DEV (Docker Py3.12), Local (Windows/Linux/macOS), CI (GitHub Actions, Py3.12)

---

## TL;DR

1) `/rag/ask` returns **stubbed** answers (`used_stub_llm=True`) instead of live LLM output.  
2) `pytest` aborts under **Python 3.12** due to Cassandra driver import failure, preventing the test suite from running cleanly.

This bundle defines precise **repro steps**, **expected vs. actual**, **root‑cause hypotheses**, and **exit‑criteria tests** (unit/functional/regression/security) that must pass to close the bug.

---

## A. Stubbed LLM Responses in Orchestrator

### Evidence & Repro

- Endpoint: `POST /rag/ask` (also `/ask` if aliased)  
- Observed response fields include `used_stub_llm: true`, and text assembled from stub classes (`OpenAI_stub` / `Claude_stub`).

**Repro (httpx/CLI):**
```bash
curl -sS http://localhost:8000/rag/ask -H "content-type: application/json"   -d '{"query":"What is the PF2E Cast a Spell action cost?"}'
# Observe: "used_stub_llm": true and templated/stub text.
```

### Expected

- When valid API keys are present and `LLM_MODE=live`, the orchestrator must call the configured provider(s) and set `used_stub_llm=false`.  
- On provider failure (quota/timeout), fall back deterministically (smaller model or stub), **and** set a `degraded=true` flag with a reason.

### Root-Cause Hypotheses

- Orchestrator hard‑wired to stub classes in current code path.  
- Missing env‑flag gate (e.g., `LLM_MODE=stub|live`, `OPENAI_API_KEY`, `ANTHROPIC_API_KEY`).  
- Missing provider client wiring and request/response mappers.

### Remediation Plan

1. **Config gates**
   - Add `LLM_MODE` env var (default: `stub` in DEV, `live` in TEST/PROD if keys exist).
   - Validate provider keys at startup; log clear capability matrix.
2. **Provider adapters**
   - Implement `providers/openai.py` and `providers/anthropic.py` thin clients.
   - Normalize outputs to `{text, model, usage, finish_reason}`.
3. **Router integration**
   - Replace stub calls with: `if LLM_MODE=='live': call provider; else: use stub`.
   - Add fallback: provider→alternate model→stub, with `degraded=true` metadata.
4. **Telemetry & safety**
   - Log model, latency, token usage; redact keys; include `policy_hash`, `prompt_hash` in metadata.

### Exit‑Criteria Tests (must pass)

**Unit**
- `tests/unit/test_llm_mode.py`
  - `test_llm_mode_stub_by_default_dev()` → no keys → stub path, `used_stub_llm=True`.
  - `test_llm_mode_live_when_keys_present()` → keys injected → live path, `used_stub_llm=False`.
  - `test_fallback_sets_degraded_flag_on_error()`.

**Functional (end‑to‑end, network mocked)**
- `tests/functional/test_ask_live_vs_stub.py`
  - Scenario A: live OpenAI mock returns 200 → answer contains `model: "gpt-*"` and `used_stub_llm=False`.
  - Scenario B: live call raises `quota_exceeded` → router falls back, response includes `degraded=true` with reason.

**Regression**
- `tests/regression/test_answer_contract.py`
  - Response schema stable: `{answer, sources[], trace_id, used_stub_llm, degraded?}`.
  - Golden prompts render deterministically (seeded).

**Security**
- `tests/security/test_llm_redaction.py`
  - Ensure logs **never** print API keys; prompts and responses scrubbed of secrets.

---

## B. Pytest Aborts Under Python 3.12 (Cassandra Driver)

### Evidence & Repro

- Import path: `src_common/vector_store/cassandra.py` (lines 11–41).  
- On import, the Cassandra driver (`cassandra-driver` / astrapy) attempts to load native deps not available in our test containers, raising `cassandra.DependencyException` (or similar), aborting **all** tests.

**Repro (clean venv):**
```bash
python -m venv .venv && . .venv/bin/activate
pip install -r requirements.txt
pytest -q
# Fails during import collection with DependencyException from Cassandra driver.
```

### Expected

- **Unit and Functional tests run cleanly** without requiring Cassandra/Astra.  
- Integration tests that truly require Cassandra are **skipped** unless an env flag is set and credentials are present.  
- A **simulation/fallback** vector store (e.g., in‑memory or Chroma) is used by default for tests and local dev.

### Root-Cause Hypotheses

- Eager module‑level imports for Cassandra driver (executed at import time).  
- No feature flag to choose an alternate backend in tests.  
- Test suite lacks markers/guards (`@pytest.mark.integration`) to isolate external dependencies.

### Remediation Plan

1. **Lazy Import & Optional Dependency Guard**
   - Wrap Cassandra imports in functions or `try/except`, raising a clear, non‑fatal error only when the Cassandra backend is **actually instantiated**.
   - Example:
     ```python
     def _load_cassandra():
         try:
             import cassandra, astrapy
             return cassandra, astrapy
         except Exception as e:
             raise RuntimeError("Cassandra backend unavailable") from e
     ```
2. **Backend Factory with Flags**
   - `VECTOR_BACKEND={astra|cassandra|chroma|memory}` (default `memory` for tests).
   - Provide a minimal **memory** or **Chroma** adapter implementing the same interface used by retrieval code.
3. **Test Markers & Skips**
   - Mark Cassandra/Astra tests as `@pytest.mark.integration and @pytest.mark.cassandra`.
   - Skip unless `RUN_CASSANDRA_TESTS=1` and required env vars set.
4. **CI Matrix**
   - Default job: runs **without** Cassandra (fast, reliable).  
   - Optional nightly job: runs Cassandra integration if secrets present.

### Exit‑Criteria Tests (must pass)

**Unit**
- `tests/unit/test_vector_backend_factory.py`
  - `test_default_backend_is_memory_in_tests()`.
  - `test_cassandra_backend_requires_env_and_raises_clear_error()` (no import at module scope).

**Functional**
- `tests/functional/test_retrieve_memory_backend.py`
  - Seed memory/chroma store; query returns Top‑K; dedup + budget applied.
- `tests/functional/test_retrieve_integration_cassandra.py` (marked)
  - **Skipped by default**; runs only with `RUN_CASSANDRA_TESTS=1` and creds; verifies connect/search.

**Regression**
- `tests/regression/test_import_collection.py`
  - `pytest --collect-only` succeeds in a clean env with no Cassandra installed.

**Security**
- `tests/security/test_cassandra_error_messages.py`
  - Error paths must not leak connection strings, tokens, or paths in exceptions/logs.

---

## C. (Optional, Related) Missing Metrics Endpoints Break Runbooks

> Lower priority than A & B but tracked here for completeness.

### Gap

- Docs mention `/metrics/performance` and `/metrics/business`, but no such routes exist; runbooks instruct `curl /metrics/*` and `/admin/ingestion/jobs` JSON (not implemented).

### Minimal Remediation & Tests

- Implement `GET /metrics/performance` and `GET /metrics/health` stubs returning validated JSON (p95 latency, error rate, uptime).  
- Add `GET /admin/ingestion/jobs` JSON view mirroring the HTML page.

**Functional Tests**
- `tests/functional/test_metrics_endpoints.py` → both endpoints return 200 and required keys.
- `tests/functional/test_admin_ingestion_jobs_api.py` → returns job list matching HTML view.

---

## Suggested Code Changes (Sketch)

- **Env/config**
  - `LLM_MODE`, `VECTOR_BACKEND`, `RUN_CASSANDRA_TESTS` flags.
- **Providers**
  - `src_common/providers/openai.py`, `anthropic.py` with minimal call adapters.
- **Vector backends**
  - `src_common/vector_store/memory.py` (for tests), `chroma.py` (optional), `cassandra.py` (lazy import).
- **Router**
  - Honor `LLM_MODE`, set `used_stub_llm` & `degraded` metadata; structured telemetry.

---

## Acceptance Checklist (All must be TRUE)

- [ ] `/rag/ask` returns **live** LLM output when keys present and `LLM_MODE=live`, with `used_stub_llm=false` and model metadata.  
- [ ] Deterministic fallback on provider failure sets `degraded=true` with a human‑readable reason.  
- [ ] `pytest -q` passes on a clean machine **without** Cassandra/Astra installed.  
- [ ] Cassandra tests are isolated behind markers and **skipped by default**; CI green without external deps.  
- [ ] (Optional) `/metrics/performance` and `/metrics/health` return validated JSON; `/admin/ingestion/jobs` JSON view exists.

---

## Appendix — Example Test Stubs

**tests/unit/test_llm_mode.py**
```python
import os
from orchestrator.router import pick_model
from orchestrator.answer import compose_answer

def test_llm_mode_live_when_keys_present(monkeypatch):
    monkeypatch.setenv("LLM_MODE","live")
    monkeypatch.setenv("OPENAI_API_KEY","sk-test")
    # mock call_llm to assert path taken
    # expect used_stub_llm == False in response metadata
```

**tests/functional/test_retrieve_memory_backend.py**
```python
def test_memory_backend_topk():
    # seed memory store with 5 docs, query, expect top_k=3 returned, dedup OK
    assert True
```

**tests/regression/test_import_collection.py**
```python
import subprocess, sys
def test_pytest_collect_only_ok():
    cp = subprocess.run([sys.executable, "-m", "pytest", "--collect-only"], capture_output=True)
    assert cp.returncode == 0, cp.stderr.decode()
```

---

**Notes:** This bug bundle intentionally avoids changing “marketing” docs; it focuses on **behavioral correctness** and **testability** so onboarding and CI are unblocked.
