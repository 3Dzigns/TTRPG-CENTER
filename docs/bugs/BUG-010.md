# BUG-010: Cache & Feedback Isolation Missing

## Summary
Currently ingestion pipeline does not respect Phase 0/6 cache bypass rules. Requirements specify **cache controls per env** (Phase 0 ARCH-004, Phase 6 TEST-004). Logs don't show cache headers or bypass behavior.

## Environment
- **System:** Cache control and feedback mechanisms
- **Components:** Ingestion pipeline, feedback APIs, admin UI
- **Requirements:** Phase 0 ARCH-004, Phase 6 TEST-004
- **Env:** DEV
- **Observed Date:** 2025-09-08

## Description of Issue
The system lacks proper cache control mechanisms:
- Ingestion pipeline doesn't respect cache bypass rules
- Feedback APIs don't have proper cache headers
- Admin UI doesn't provide cache control toggles
- No environment-specific cache TTL configuration

## Impact
- **Stale Data**: Retests may show stale answers even after ingestion
- **Feedback Delays**: Feedback loops (üëç/üëé) may not update Admin UI immediately
- **Testing Issues**: Cache interference affects regression testing
- **Requirements Violation**: Breaks Phase 0/6 cache control requirements

## Root Cause Analysis
1. **Missing Cache Headers**: APIs don't set appropriate cache control headers
2. **No Cache Bypass**: No mechanism to bypass cache for critical operations
3. **Missing Admin Controls**: Admin UI lacks cache management toggles
4. **No Environment Awareness**: Cache behavior not differentiated by environment

## Expected Behavior
- Cache controls properly configured per environment
- Feedback APIs return fresh state immediately
- Admin UI provides cache management controls
- Ingestion operations bypass cache when appropriate

## Actual Behavior
- No cache control headers in API responses
- Stale data served after ingestion operations
- No admin cache control interface

## Proposed Fix
1. **Implement Cache Headers**
   - Enforce `Cache-Control: no-store` for feedback APIs
   - Add appropriate TTLs to ingestion endpoints
   - Environment-specific cache configurations
2. **Admin UI Controls**
   - Admin UI toggle: "Disable cache now"
   - Cache status monitoring
   - Manual cache clear functionality
3. **Environment Configuration**
   - DEV: Very short TTLs (‚â§5s) or no-cache for dynamic content
   - TEST: Configurable cache for testing scenarios
   - PROD: Appropriate TTLs for performance

## Technical Implementation
```python
from functools import wraps
from flask import request, make_response
import os

class CacheControlMiddleware:
    def __init__(self, app):
        self.app = app
        self.environment = os.getenv('APP_ENV', 'dev')
        
    def __call__(self, environ, start_response):
        def new_start_response(status, response_headers, exc_info=None):
            # Add cache control headers based on environment and endpoint
            if self.should_add_cache_headers(environ['PATH_INFO']):
                cache_header = self.get_cache_header(environ['PATH_INFO'])
                response_headers.append(('Cache-Control', cache_header))
            
            return start_response(status, response_headers, exc_info)
        
        return self.app(environ, new_start_response)
    
    def should_add_cache_headers(self, path: str) -> bool:
        # Add cache headers to API endpoints
        return path.startswith('/api/')
    
    def get_cache_header(self, path: str) -> str:
        if '/feedback' in path:
            return 'no-store, must-revalidate'
        elif self.environment == 'dev':
            return 'max-age=5, must-revalidate'
        elif self.environment == 'test':
            return 'max-age=30, must-revalidate'
        else:  # prod
            return 'max-age=300, public'

# Decorator for API endpoints
def cache_control(cache_type='default'):
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            response = make_response(f(*args, **kwargs))
            
            if cache_type == 'no-cache':
                response.headers['Cache-Control'] = 'no-store, must-revalidate'
            elif cache_type == 'feedback':
                response.headers['Cache-Control'] = 'no-store, must-revalidate'
            elif cache_type == 'short':
                response.headers['Cache-Control'] = 'max-age=5, must-revalidate'
            
            return response
        return decorated_function
    return decorator

# Usage in feedback APIs
@app.route('/api/feedback', methods=['POST'])
@cache_control('feedback')
def submit_feedback():
    # Feedback processing logic
    return {"status": "success"}

# Admin cache control endpoint
@app.route('/api/admin/cache/clear', methods=['POST'])
@require_admin
def clear_cache():
    cache.clear()
    return {"status": "cache cleared"}

@app.route('/api/admin/cache/status', methods=['GET'])
@require_admin  
def cache_status():
    return {
        "environment": os.getenv('APP_ENV'),
        "cache_enabled": cache.is_enabled(),
        "cache_size": cache.size(),
        "hit_ratio": cache.hit_ratio()
    }
```

## Acceptance Criteria
- ‚úÖ Feedback APIs return fresh state instantly (no-store cache headers)
- ‚úÖ Environment-specific cache TTL configuration implemented
- ‚úÖ Admin UI provides cache control toggles and status monitoring
- ‚úÖ Ingestion operations properly bypass cache when needed
- ‚úÖ Cache headers appropriately set for all API endpoints

## Automated Tests

### Unit Tests
- **Cache Headers**: Feedback API returns `Cache-Control: no-store` header
- **Environment Config**: Different environments have appropriate TTLs
- **Admin Controls**: Cache clear and status endpoints function correctly

### Functional Tests
- **Immediate Updates**: User üëç ‚Üí Admin UI shows regression test immediately
- **Cache Bypass**: Ingestion operations don't serve stale cached data
- **Admin Interface**: Admin cache controls work as expected

### Regression Tests
- **Performance**: Old cache behavior still works in PROD with appropriate TTL
- **Backward Compatibility**: Existing functionality not broken by cache changes
- **Environment Isolation**: Cache behavior properly isolated between environments

### Security Tests
- **Cache Poisoning**: Prevent cache poisoning attacks
- **Admin Authorization**: Cache control endpoints require proper admin access
- **DoS Protection**: Cache operations can't be used for denial of service

## Environment-Specific Configuration
```yaml
# dev.yml
cache:
  default_ttl: 5
  feedback_ttl: 0  # no-store
  admin_controls: true
  bypass_on_ingestion: true

# test.yml  
cache:
  default_ttl: 30
  feedback_ttl: 0
  admin_controls: true
  bypass_on_ingestion: true

# prod.yml
cache:
  default_ttl: 300
  feedback_ttl: 0
  admin_controls: true
  bypass_on_ingestion: false
```

## Definition of Done
- Cache control middleware implemented with environment awareness
- Feedback APIs have no-store cache headers
- Admin UI provides cache management interface
- All tests pass (Unit/Functional/Regression/Security)
- Environment-specific cache configurations working
- Documentation updated with cache control behavior and admin procedures