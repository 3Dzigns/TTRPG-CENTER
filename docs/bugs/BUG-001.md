# ðŸ“„ BUG-001.md

## Title
**Chunk/Dataset Mismatch & Missing Logs in Bulk Ingestion (6-Pass Pipeline)**

## Environment
- **Script:** `scripts/bulk_ingest.py`
- **Pipeline:** 6-Pass (Aâ€“F)
- **Command Run:**  
  ```
  .venv\Scripts\python.exe scripts/bulk_ingest.py --env dev --threads 4 --empty-first --empty-dict-first --upload-dir uploads --force-dict-init
  ```
- **Env:** DEV  
- **Observed Date:** 2025-09-08  

---

## Description of Issue
After ingesting **6 source PDFs**:
- **Dictionary** was updated successfully (~700+ terms).  
- **Chunks** persisted in Astra/artifacts totalled **<900** (unexpectedly low).  
- Expectation: ~several thousand chunks (6 books Ã— hundreds of chunks).  
- **Logs** for the most recent run were missing from `env/dev/logs/`.

---

## Impact
- Potential **loss of ingestion coverage** (rules, spells, feats missing).  
- **Graph workflows (Phase 3)** and **retrieval accuracy (Phase 2)** will be degraded.  
- **Dictionary and chunks out of sync** â†’ provenance failures.  
- Missing logs break **auditability** (Phase 4/7 compliance).  

---

## Root Cause Hypotheses
1. **Per-Source Cleanup Between Runs**  
   - `bulk_ingest.py` may overwrite artifacts for subsequent sources due to reuse of `manifest.json` or `output_dir`.  
   - Suspected in `_process_source_sequential`.

2. **Resume/Skip Logic**  
   - `_should_run_pass` incorrectly skips valid sources if dictionary already primed.  
   - `resume=True` path might falsely mark passes complete.

3. **Multi-Threading Race**  
   - Barrier control (`source_locks`) may not fully isolate thread operations â†’ skipped writes or incomplete merges.

4. **Logging Setup**  
   - `--no-logfile` not passed, but log file missing.  
   - Likely `setup_logging()` mis-configured after `log_file` path computed.

---

## Steps to Reproduce
1. Place â‰¥2 PDFs into `uploads/`.  
2. Run ingestion command with `--threads 4 --empty-first --empty-dict-first --force-dict-init`.  
3. Inspect:
   - `artifacts/ingest/dev/*/manifest.json`  
   - `env/dev/logs/bulk_ingest_*.log`  
   - Astra collections for chunk vs. dictionary counts.  

---

## Expected Behavior
- All 6 source PDFs produce **non-trivial chunk counts** (>100 per book).  
- Dictionary entry count should align with chunk coverage.  
- Log file written to `env/dev/logs/bulk_ingest_<timestamp>.log`.

---

## Actual Behavior
- Dictionary entries: ~700+  
- Chunks: ~900 total  
- Logs: Missing for last run  

---

## Required Fixes
- âœ… Ensure **per-source artifact directories** never overwrite each other.  
- âœ… Fix **resume/skip logic**: only skip when *all* pass outputs exist and are validated.  
- âœ… Validate **thread barrier isolation** across sources.  
- âœ… Harden **logging setup**: always write `bulk_ingest_<timestamp>.log`.  
- âœ… Add explicit **chunk vs. dictionary consistency check** at end of pipeline.  

---

## Automated Test Cases

### 1. Unit Tests
- **`tests/unit/test_bulk_ingest_manifest.py`**  
  - Verify `_should_run_pass` correctly skips only if manifest marks pass complete.  
  - Simulate corrupt manifest â†’ ensure re-run.

- **`tests/unit/test_logging_setup.py`**  
  - Ensure `--no-logfile` writes console only; default always creates logfile.

---

### 2. Functional Tests
- **Scenario A â€” Multi-Source Run**  
  - Input: 2 PDFs, force dict init.  
  - Expect: 2 distinct job directories under `artifacts/ingest/dev/`.  
  - Each manifest has non-empty chunk arrays.  
  - Log file exists.

- **Scenario B â€” Resume Run**  
  - Input: rerun with `--resume`.  
  - Expect: unchanged dictionary count; chunks not deleted; skipped passes logged.

---

### 3. Regression Tests
- Canonical 2-book run must yield:  
  - `chunks_count â‰¥ dictionary_terms`  
  - `len(artifacts/ingest/dev/*/manifest.json) == #books`  
  - Logs present in `env/dev/logs`.

---

### 4. Security Tests
- Ensure ingestion cannot silently discard chunks without emitting `logger.error`.  
- Verify logfiles redact secrets (Phase 0 SEC-001, Phase 4 US-403).  

---

## Definition of Done
- All phases pass Unit/Functional/Regression/Security tests in CI.  
- Dictionary and chunk counts consistent across 3 runs.  
- Log files always created unless `--no-logfile` flag used.  
- Bug bundle stored at `artifacts/bugs/BUG-001/bundle.json` with `{query, logs, manifest}`.  
