# BP005 - Design Drift: Persona Pipeline, Encoding Corruption, and API Contract Gaps

**Priority:** High  
**Date Created:** 2025-09-05  
**Components:** Personas pipeline (Phases 2/4), Docs & UI (Phases 4/7), Requirements API (Phase 7)  
**Severity:** Release Blocker for Personas; Medium for others  
**Reported By:** Full code analysis against Phase design docs

## Summary

The repository largely implements the seven-phase design, but several issues deviate from the intended behavior and quality targets:

- The standalone persona answers script has unreachable logic and never produces its promised artifacts.
- Pervasive mojibake/encoding corruption in docs and templates undermines readability and parsing.
- The Phase 7 feature request status model is inconsistent across schema, API, and workflow (scope drift beyond Approve/Reject).
- A minor naming inconsistency exists in Personas.
- There is an optional risk of module-name shadowing around logging.

These deviations affect developer and user workflows (report generation, QA parsing, and API clarity) and should be addressed to align with the design.

---

## Detailed Issues

### P1: Persona Answers Script – Dead Code Path and Early Return

- Location: `scripts/answer_personas.py:90` (def main), `scripts/answer_personas.py:208` (def retrieve)
- Impact: The main script never iterates persona files or writes reports. All the persona extraction, retrieval, and report writing code is placed after an early `return` inside `retrieve()` and outside the `main()` function. As a result, running the script completes silently without producing `artifacts/reports/persona_answers_{env}.md`.
- Evidence:
  - `def main()` initializes env/sys.path only; persona loop and outputs are not in its scope.
  - `def retrieve()` concludes with `return out`, followed by top-indented code that is unreachable (still within the function body in Python).
- Expected:
  - `main()` should orchestrate: iterate persona files → extract Q/As → retrieve context → synthesize answers → write markdown and JSON reports.
  - No code after a `return` should exist in `retrieve()`.
- Actual:
  - Running `python scripts/answer_personas.py` creates no report files and performs no measurable work.
- Repro:
  1) From repo root, run: `python scripts/answer_personas.py`  
  2) Inspect `artifacts/reports/` — expected report is missing.

### P2: Mojibake/Encoding Corruption in Docs and UI

- Locations (examples): `Personas/Eberron_Personsas.md:1`, `docs/phases/Phase7.md:1`, `scripts/preflight.ps1:1`, `templates/requirements_dashboard.html:1`
- Impact: Garbled characters (replacement diamonds/"�"-like artifacts) appear in personas, phase documents, templates, and scripts. This breaks readability and can impair automated parsing, regex-based extraction, and tests or scripts that scan for structured tokens. The presence of workarounds in code (e.g., `_clean_quotes` in pipeline scripts) indicates the corruption is known but not systematically addressed.
- Expected:
  - All textual assets in clean UTF-8 without mojibake; standardized straight quotes and em-dash usage.
- Actual:
  - Files contain corrupted smart quotes and symbols likely introduced by inconsistent encoding conversions (CP-1252/Windows-1252 vs UTF-8).
- Repro:
  - Open any affected file in a text editor or render the templates; visible artifacts appear in headings and bullet content.

### P3: Phase 7 Feature Status Model Drift (Schema vs API vs Workflow)

- Locations: `schemas/feature_request.schema.json:1`, `app_requirements.py:...` list API, `src_common/requirements_manager.py:...` FeatureRequest handling
- Impact: The schema permits statuses beyond the Phase 7 design (e.g., `in_progress`, `completed`, `cancelled`), while the implemented workflow and manager only support `pending`, `approved`, `rejected`. The API query filter also accepts the extended statuses but there is no path to set them. This creates an unclear contract and potential UI/API confusion.
- Expected:
  - Phase 7 US-703 specifies Approve/Reject; status set in audit trail accordingly. Either restrict schema and API to the three statuses or implement Phase 7+ workflow for extended states with endpoints and UI.
- Actual:
  - Extended statuses are accepted by schema and query, but never produced by the system.

### P4: Naming Inconsistency in Personas Filename

- Location: `Personas/Eberron_Personsas.md:1`
- Issue: Filename uses `Personsas` instead of `Personas`. While globbing `*.md` still finds the file, the typo hurts discoverability and can break ad hoc glob filters (e.g., `Eberron_Personas*.md`).

### P5: Optional – Module Name Shadowing Risk for Logging

- Locations: `src_common/logging.py:1`, `src_common/ttrpg_logging.py:1`, `scripts/run_personas_via_pipeline.py:1`
- Impact: A compatibility shim under the name `logging` can shadow Python’s stdlib `logging`. Some scripts work around this (rebinding `sys.modules['logging']`), but this pattern is fragile and may have side effects in third-party libs relying on stdlib logging.
- Expected:
  - Use `src_common.ttrpg_logging` explicitly from app code; avoid exporting under the stdlib module name.

---

## Suggested Fixes (High Level)

- P1: Refactor `scripts/answer_personas.py` so `main()` performs orchestration, move the persona loop and report writing inside `main()`, and remove unreachable code after `return` in `retrieve()`.
- P2: Normalize repository text encodings to UTF-8; replace smart quotes with ASCII/safe Unicode, and add a pre-commit hook to fail on mojibake. Consider an automated one-time cleanup and a CI linter that flags `\uFFFD` or Windows-1252 artifacts.
- P3: Pick one: (a) restrict schema and API to `pending|approved|rejected` or (b) implement extended lifecycle (start, complete, cancel) with corresponding API routes, UI affordances, and audit logging.
- P4: Rename the Eberron personas file for consistency; update any references.
- P5: Deprecate the `logging` shim; ensure imports use `src_common.ttrpg_logging` or keep the shim but prevent it from shadowing stdlib unintentionally (e.g., use absolute imports; avoid `from logging import ...` without prior sys.path isolation).

---

## User Stories for Fixes

### US-BP005-1: Repair Persona Answers Script
**As a** QA Engineer  
**I want** the persona answers script to reliably generate markdown/JSON reports  
**So that** we can evaluate retrieval quality against the designed personas

Acceptance Criteria:
- `python scripts/answer_personas.py` creates `artifacts/reports/persona_answers_{env}.md` and `.json`.
- Code under `main()` iterates all `Personas/*.md`, extracts Q/As, retrieves top-k chunks, synthesizes answers, and writes citations.
- No unreachable code remains after returns; unit test validates report creation when no Astra is configured (local fallback).

### US-BP005-2: Repository-wide Encoding Normalization
**As a** Developer  
**I want** all repository text assets to be clean UTF-8 without mojibake  
**So that** docs render cleanly and scripts/tests can parse reliably

Acceptance Criteria:
- All `docs/**`, `templates/**`, `scripts/**`, and `Personas/**` files lint clean for `\uFFFD` and common CP-1252 artifacts.
- Introduce a pre-commit check that fails on non-UTF-8 or presence of `\uFFFD`/problem sequences.
- Replace smart quotes and ambiguous dashes with normalized characters; enforce via editorconfig or lint.

### US-BP005-3: Phase 7 Status Model Alignment
**As a** Product Owner  
**I want** consistent feature request statuses across schema, API, and workflow  
**So that** the admin UI and audit trail accurately reflect the designed lifecycle

Acceptance Criteria (Option A – Restrict):
- Schema `status` enum reduced to `pending|approved|rejected`.
- API query regex and docs updated to the same set.
- Tests updated to assert only these statuses.

Acceptance Criteria (Option B – Extend):
- Implement endpoints for `start`, `complete`, and `cancel` with audit entries.
- UI surfaces actions for extended states; schema kept as-is.
- Add integration tests to move through extended lifecycle.

### US-BP005-4: Fix Personas Filename
**As a** Content Editor  
**I want** consistent persona filenames  
**So that** scripts, filters, and contributors don’t miss files by typo

Acceptance Criteria:
- Rename `Personas/Eberron_Personsas.md` → `Personas/Eberron_Personas.md`.
- Update any direct references; verify `scripts/run_personas_via_pipeline.py --glob "Eberron*"` finds the file.

### US-BP005-5: Logging Import Hygiene
**As a** Developer  
**I want** explicit logging imports without module shadowing  
**So that** stdlib `logging` behavior remains predictable for third-party libs

Acceptance Criteria:
- Replace `from logging import ...` in project code with `from src_common.ttrpg_logging import ...` (or `from src_common import logging as tlog` with explicit names).
- Remove `sys.modules` workarounds from scripts; tests still pass.
- Document logging import pattern in CONTRIBUTING.md.

---

## References

- Design: `docs/phases/Phase7.md:1` (Status workflow expectations)  
- Script: `scripts/answer_personas.py:90`, `scripts/answer_personas.py:208`  
- Schema: `schemas/feature_request.schema.json:1`  
- API: `app_requirements.py:1`  
- Manager: `src_common/requirements_manager.py:1`  
- Personas: `Personas/Eberron_Personsas.md:1`  
- UI Template: `templates/requirements_dashboard.html:1`  
- Encoding artifacts example: `scripts/run_personas_via_pipeline.py:1`, `scripts/preflight.ps1:1`

