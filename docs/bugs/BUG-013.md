# BUG-020: Dictionary upsert fails due to mixed $setOnInsert and $addToSet on 'sources'


## Summary
Dictionary upserts to **ttrpg_dictionary_dev** fail because a single `updateOne` mixes `$setOnInsert` and `$addToSet` **on the same path** (`sources`). Astra's Document API rejects this.

**Log Signal**: `Unsupported update operation parameter ... '$addToSet' and '$setOnInsert' must not refer to same path: 'sources'`.

## Impact
* Zero dictionary entries are created/updated; downstream features relying on dictionary are empty.

## Root Cause
The upsert tries to both create new docs and add to the `sources` array in one call, which Astra forbids.

## Fix
Use **two-step upsert**:
1. `updateOne(filter, { $setOnInsert: { _id, term, kind, created_at }, $set: { updated_at } }, upsert=true)`
2. `updateOne(filter, { $addToSet: { sources: { $each: incomingSources } } })`

Alternatively: on insert, initialize `sources` to an empty array in step 1 and only modify it in step 2.

## Acceptance Criteria (User Stories)
**US-020A (Dev)**: As a pipeline developer, I can run ToC ingestion and see dictionary entries created without any `UNSUPPORTED_UPDATE_OPERATION_PARAM` warnings.
**US-020B (Admin)**: As an admin, the dictionary viewer shows newly added terms with their `sources` populated.

## Test Cases
**Unit**
- Build an in-memory mock of the Astra collection; call the two-step function → verify two calls and final doc has `sources` with deduped entries.
- Attempt a single-call mixed-update → ensure code prevents it (raises ValueError).

**Functional**
- Run ingestion on a small PDF with 3 ToC terms → dictionary shows 3 new docs, each with at least one source entry.

**Regression**
- Re-run on same PDF → `sources` remain deduped (no duplicates).

**Security**
- Inputs to `sources` are sanitized (no control chars), and pages are integers.
