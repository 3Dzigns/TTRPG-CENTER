# BUG-002: HTTP/HTTPS mismatch — missing canonical redirect

## Summary
Users can reach the app via both HTTP and HTTPS. When a user lands on the non-canonical scheme, the app **does not auto-redirect** to the canonical one. This creates mixed‑content risks, login/session confusion, and SEO duplication.

## Environment
- Web stack: FastAPI (backend) + reverse proxy (nginx/Traefik/IIS) (assumed)
- Affected routes: All (`/`, `/admin`, `/api/*`, static assets)

## Expected
- **Single canonical scheme** (HTTPS in PROD/TEST; HTTP allowed in DEV). Any request arriving on the wrong scheme is **301/308** redirected to the canonical origin and same path/query.
- HSTS (PROD) and `X-Forwarded-Proto` respected behind a proxy.

## Actual
- No redirect occurs; both schemes render pages independently.

## Impact
- Session/auth issues; possible CSRF/mixed‑content; SEO duplication; broken third‑party callbacks that expect a single origin.

## Proposed Fix
1. **Reverse proxy rule (preferred)**
   - Nginx:
     ```nginx
     # HTTP -> HTTPS
     server {
       listen 80;
       server_name example.com;
       return 308 https://$host$request_uri;
     }
     # HTTPS upstream
     server {
       listen 443 ssl http2;
       server_name example.com;
       proxy_set_header X-Forwarded-Proto https;
       proxy_pass http://app_upstream;
     }
     ```
   - Ensure `proxy_set_header X-Forwarded-Proto https;` so the app can build absolute URLs correctly.
2. **Backend safety net (FastAPI middleware)**
   ```python
   # middleware/redirect_scheme.py
   from starlette.middleware.base import BaseHTTPMiddleware
   from starlette.responses import RedirectResponse
   import os

   CANONICAL_SCHEME = os.getenv("CANONICAL_SCHEME", "https")

   class EnforceSchemeMiddleware(BaseHTTPMiddleware):
       async def dispatch(self, request, call_next):
           xf_proto = request.headers.get("x-forwarded-proto") or request.url.scheme
           if CANONICAL_SCHEME != "http" and xf_proto != CANONICAL_SCHEME:
               target = request.url.replace(scheme=CANONICAL_SCHEME)
               return RedirectResponse(str(target), status_code=308)
           return await call_next(request)
   ```
3. **Enable HSTS (PROD only):**
   `Strict-Transport-Security: max-age=31536000; includeSubDomains; preload`

## Acceptance Criteria
- Hitting `http://<host>/any/path?x=1` returns **308** to `https://<host>/any/path?x=1` (TEST/PROD).
- DEV may keep HTTP without redirect (config flag).

## Automated Tests
- **pytest (FastAPI TestClient)**:
  ```python
  def test_http_redirects_to_https(test_client_http):
      r = test_client_http.get("/status?x=1", allow_redirects=False)
      assert r.status_code in (301, 308)
      assert r.headers["location"].startswith("https://")
  ```
- **e2e (Playwright)**:
  - Navigate to `http://…/admin` → browser ends on `https://…/admin`.
- **Security**:
  - HSTS present in PROD, absent in DEV.
