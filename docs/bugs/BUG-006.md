# BUG-006: Database Cleanup Strategy Interferes with Ingestion

## Summary
The current bulk ingestion pipeline **empties AstraDB collections (`ttrpg_chunks_dev`, `ttrpg_dictionary_dev`) at the start of every run**. This wipes existing data even if only incremental ingestion was intended. It also runs inside the ingestion job itself, creating a race condition between "clean" and "ingest."

## Environment
- **Script:** `scripts/bulk_ingest.py`
- **Pipeline:** 6-Pass (A–F)
- **Database:** AstraDB collections
- **Env:** DEV
- **Observed Date:** 2025-09-08

## Description of Issue
The ingestion pipeline automatically empties database collections at startup, which:
- Wipes existing data even for incremental ingestion
- Creates race conditions in multi-threaded environments
- Violates organic dictionary growth requirements
- Results in fewer DB entries than expected

## Impact
- **Data Loss**: Far fewer entries appear in DB than expected
- **Race Conditions**: Running multiple PDFs in parallel increases risk of collection wipe while other threads are still ingesting
- **Requirements Violation**: Breaks requirement for **organic dictionary growth** (Phase 1 RAG-003)
- **Operational Risk**: No clear separation between reset and incremental operations

## Root Cause Analysis
1. **Automatic Cleanup**: Database cleanup runs automatically at ingestion start
2. **No Incremental Mode**: No option for incremental updates without cleanup
3. **Thread Unsafe**: Cleanup runs inside ingestion job, creating race conditions
4. **Admin Control Missing**: No explicit admin control for database reset

## Expected Behavior
- Ingestion should default to **incremental update**
- Database cleanup should be a separate, explicit admin action
- No race conditions between cleanup and ingestion threads
- Clear separation between reset and incremental operations

## Actual Behavior
- All collections emptied at start of every ingestion run
- Data loss when multiple ingestion jobs run concurrently
- No incremental ingestion capability

## Proposed Fix
1. **Decouple DB cleanup from ingestion**
   - Remove automatic cleanup from ingestion pipeline
   - Create separate database reset functionality
2. **Admin Control**
   - Provide explicit **"reset database"** admin action (Phase 4 Admin UI)
   - Add config flag: `--reset-db` (true/false)
3. **Default Incremental**
   - Ingestion should default to **incremental update**
   - Preserve existing data unless explicitly requested to reset

## Acceptance Criteria
- ✅ Database cleanup only runs when `--reset-db` flag is set
- ✅ Default ingestion mode is incremental (preserves existing data)
- ✅ Admin UI provides explicit database reset control
- ✅ No race conditions between cleanup and ingestion threads
- ✅ Production environments have additional safeguards against accidental resets

## Automated Tests

### Unit Tests
- **Cleanup Control**: Cleanup only runs when `--reset-db` is set
- **Default Behavior**: Default ingestion preserves existing data
- **Flag Validation**: `--reset-db` flag properly controls cleanup behavior

### Functional Tests
- **Concurrent Safety**: Run two ingestion jobs concurrently; neither deletes the other's data
- **Incremental Growth**: Multiple ingestion runs increase database size
- **Reset Functionality**: Reset flag properly empties collections when used

### Regression Tests
- **Data Preservation**: DB counts only increase when new PDFs are added
- **Backward Compatibility**: Existing ingestion workflows continue to work

### Security Tests
- **Production Safety**: Ensure `--reset-db` not accidentally enabled in PROD
- **Admin Authorization**: Database reset requires proper admin authentication
- **Audit Trail**: Database reset operations are logged and auditable

## Definition of Done
- Database cleanup decoupled from ingestion pipeline
- Admin UI provides explicit database reset control
- Default ingestion mode preserves existing data
- All tests pass (Unit/Functional/Regression/Security)
- Documentation updated with new incremental ingestion behavior
- Production safeguards in place for database reset operations