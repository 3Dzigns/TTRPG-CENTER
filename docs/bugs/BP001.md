# BF001 — Phase 0 and Phase 1 Gaps and Fix Plan

- Scope: Review of Phase 0 and Phase 1 against the current codebase and root .md requirements
- Date: 2025-09-04
- Repo root: TTRPG_Center

## Summary

Overall Phase 0 foundations are present (env skeletons, FastAPI app with health, CI workflows, basic tests, structured logging), but several gating items are incomplete or misaligned with specs. Phase 1 has scaffolding for real tools (unstructured.io, Haystack, LlamaIndex) but is missing hard-gate enforcement, contract file paths/names, manifest management, and Astra dictionary writes. There are also module import mismatches that will cause tests and preflight to fail.

The following issues and user stories outline concrete corrections to fully meet Phase 0 and Phase 1 acceptance criteria.

## Phase 0 Findings

- P0-001: Missing required build/promotion scripts per ARCH-003
  - Observed: `scripts/` does not contain `build.ps1`, `promote.ps1`, `rollback.ps1`.
  - Impact: Cannot produce immutable builds with timestamped IDs nor promote/rollback between `env/*` directories as required.
  - User Story: As a release engineer, I want `build.ps1`, `promote.ps1`, and `rollback.ps1` that operate strictly within `env/<env>` so that builds are immutable per environment and promotions/rollbacks are auditable.
  - Acceptance:
    - `build.ps1` writes `builds/<ENV>/<YYYYMMDD-HHMMSS>/` with copied `code/` and a `build.json` (id, git sha, time, tool versions).
    - `promote.ps1` updates `env/<target>/code` from a specific build id and records a `promotion.json` with source/dest/build id.
    - `rollback.ps1` points `env/<target>/code` back to a prior build id and records `rollback.json`.
    - All scripts refuse cross-environment writes and log actions.

- P0-002: Module import mismatch breaks tests and scripts
  - Observed: Tests and scripts import `src_common.logging` and `src_common.secrets` but files present are `ttrpg_logging.py` and `ttrpg_secrets.py`.
  - Impact: `pytest` and `scripts/run-local.ps1` preflight imports fail, breaking Phase 0 CI gates.
  - User Story: As a developer, I want canonical module paths (`src_common/logging.py`, `src_common/secrets.py`) so tests and scripts import consistently across environments.
  - Acceptance:
    - Add thin modules `src_common/logging.py` and `src_common/secrets.py` that re-export from `ttrpg_logging` and `ttrpg_secrets` (or rename files to match).
    - Update `scripts/run-local.ps1` embedded Python to `from src_common.logging import jlog, setup_logging` (not stdlib `logging`).
    - CI green on unit/functional/security.

- P0-003: Cache-control policy not implemented (ARCH-004)
  - Observed: `/healthz` and other endpoints do not set cache headers; `.env.template` has `CACHE_TTL_SECONDS`, but no middleware applies it.
  - Impact: WebUI retesting may reflect stale responses, failing fast-retest acceptance.
  - User Story: As an operator, I want cache headers applied per environment so that responses in DEV are `no-store`, TEST ~5s TTL, PROD configurable.
  - Acceptance:
    - HTTP middleware adds `Cache-Control` based on `CACHE_TTL_SECONDS` (`0` -> `no-store`, else `max-age=<ttl>, private`).
    - Admin toggle endpoint `POST /admin/cache/disable` sets a short-lived override flag in-process; reflected on next request.
    - Manual tests show re-requests reflect updates within policy windows.

- P0-004: CORS policy is wide-open
  - Observed: `allow_origins=["*"]` in `src_common/app.py`.
  - Impact: Not production-safe and contradicts recommendations.
  - User Story: As a platform engineer, I want environment-specific CORS.
  - Acceptance: DEV `*`, TEST allow `http://localhost:*`, PROD allowlist from `env/<env>/config/origins.json` or `.env` variable.

- P0-005: Environment config parity gaps
  - Observed: Only `env/dev/config` exists in repo; scripts create others on demand. That’s acceptable, but tests assert unique `http_port` and `websocket_port` for all three envs.
  - User Story: As a developer, I want `init-environments.*` to reliably materialize `ports.json`, `.env(.template)`, and `logging.json` for `dev/test/prod`.
  - Acceptance: Running `init-environments.ps1/sh` for each env creates all files with ports `8000/8181/8282` and WS `9000/9181/9282` (as already coded).

- P0-006: `__main__` block in `src_common/app.py` incomplete
  - Observed: The file ends after `if __name__ == "__main__":` with no server launch.
  - User Story: As a developer, I want `python -m src_common.app` to run uvicorn for quick local tests.
  - Acceptance: Main block calls `uvicorn.run(app, host=..., port=int(PORT))` reading env.

## Phase 1 Findings

- P1-001: Artifact paths and filenames do not match contract
  - Observed: Real pass code writes `./artifacts/{env}/{job_id}/` and file names prefixed with job id (e.g., `{job_id}_pass_b_enriched.json`). Spec requires `artifacts/ingest/{ENV}/{JOB_ID}/passA_chunks.json`, `passB_enriched.json`, `passB_dictionary_delta.json`, `passC_graph.json`.
  - Impact: Contract checks and downstream tools will fail to find expected files.
  - User Story: As a pipeline operator, I want artifact paths/names to strictly match the spec so downstream consumers and tests work deterministically.
  - Acceptance: All three passes produce exactly the specified filenames under `artifacts/ingest/{ENV}/{JOB_ID}/`.

- P1-002: Manifest and hard-gate enforcement missing for real passes
  - Observed: `mock_ingest` maintains a `manifest` in-memory but real Pass A/B/C do not write `manifest.json` nor gate on contract validation.
  - Impact: Fails “hard gate” acceptance — pass must fail the whole job when outputs deviate.
  - User Story: As a maintainer, I want a `manifest.json` that each pass updates (tool versions, counts, checksums, timings) and pass-level validators that fail the job on contract violations.
  - Acceptance:
    - `manifest.json` created before Pass A and updated after each pass with fields: `tool_version`, `exit_code`, `timings`, `output_counts`, SHA256 hashes of normalized texts, and `status`.
    - If any validation fails (schema, coverage, determinism), set job `status=failed` and stop subsequent passes.

- P1-003: Tool version capture not persisted
  - Observed: No explicit recording of `unstructured --version`, Haystack, or LlamaIndex versions in artifacts/manifest.
  - User Story: As an SRE, I need each pass to record tool versions used to generate outputs.
  - Acceptance: `manifest.json` includes `tools: {unstructured, haystack, llama_index}` with versions for the run.

- P1-004: Dictionary AstraDB upsert not implemented
  - Observed: Pass B writes dictionary delta to file only; no Astra write or dry-run logging.
  - Impact: Fails RAG-003 acceptance (dynamic dictionary system backed by Astra, with CI fallback).
  - User Story: As a data engineer, I want dictionary delta upserted to AstraDB when configured, else persisted locally with dry-run logs proving intent.
  - Acceptance:
    - If `ASTRA_*` env present, upsert into `ttrpg_dictionary` collection with idempotent key; log upsert counts.
    - If not, write delta to file and log “dry-run” with would-be upsert summary.

- P1-005: Graph schema not aligned with contract
  - Observed: Current `PassC` uses `{id, node_type, content, ...}` and edges `{from_node, to_node, edge_type, ...}`. Spec calls for nodes `{id, kind in ['chunk','term'], label}` (or Phase1 doc nodes/edges contract) and edges `{src, dst, rel}` with determinism metrics.
  - Impact: Contract and future workflow graph integration may fail.
  - User Story: As a knowledge engineer, I want Pass C outputs to match the specified node/edge schema and include determinism metrics.
  - Acceptance: Output matches schema; counts and adjacency checksums recorded in `manifest.json`.

- P1-006: Real-tool integration tests missing
  - Observed: No focused tests that run Unstructured/Haystack/LlamaIndex “for real” on fixtures and enforce acceptance contracts (schema, coverage, determinism, timing).
  - User Story: As QA, I want integration tests for Pass A/B/C that validate contract and performance on `tests/fixtures/sample_short.pdf` and `sample_medium.pdf`.
  - Acceptance: New tests in `tests/functional` assert contract compliance, version capture, and gate failure behavior; CI executes them.

- P1-007: Ingestion Console (WebUI) not implemented
  - Observed: WebSocket endpoint exists, and mock job broadcasts, but no minimal WebUI for pass status/log tails.
  - User Story: As an operator, I want a minimal WebUI page that shows per-phase progress and the last 10–20 logs, scoped by environment directory.
  - Acceptance: A simple static page under `/admin/ingestion` (or served separately) connects to `/ws`, filters messages by `ENV`, and displays per-pass status and recent logs.

## Cross-Cutting Quality Items (supporting Phase 0/1)

- Q-001: Logging and secrets naming consistency
  - Fix imports and file names so `src_common.logging` and `src_common.secrets` are canonical and used everywhere (app, scripts, tests).

- Q-002: Security hardening from code analysis report
  - Restrict CORS in PROD, avoid `0.0.0.0` unless explicitly required, replace any MD5 usage with SHA-256 in graph compilers, ensure no secrets in logs.

## Proposed Implementation Plan (high level)

1) Fix imports and paths (P0-002, Q-001) — add canonical modules or rename files; update `run-local.ps1` Python snippet. Make CI green on Phase 0 tests.
2) Add cache/CORS controls (P0-003, P0-004) — lightweight middleware and env-driven config.
3) Add build/promote/rollback scripts (P0-001) — minimal, environment-scoped, with audit JSON.
4) Align artifact paths and filenames (P1-001) — converge to `artifacts/ingest/{ENV}/{JOB_ID}/...`.
5) Add `manifest.json` and hard-gate validators (P1-002, P1-003) — per-pass validators, version capture, SHA256s, timings.
6) Implement Astra dictionary upsert with dry-run fallback (P1-004).
7) Align Pass C schema and determinism metrics (P1-005).
8) Add real-tool integration tests with fixtures (P1-006) and a minimal Ingestion Console page (P1-007).

## Acceptance Checklist

- Phase 0
  - Environments initialize for dev/test/prod with unique ports and isolated dirs
  - CI runs unit/functional/security green; preflight passes locally
  - Health endpoint returns fresh data, with cache headers honoring env policy
  - Build/promotion/rollback scripts produce immutable artifacts and logs

- Phase 1
  - Three passes run “for real,” produce contract-compliant outputs at the specified path
  - `manifest.json` records versions/checksums/timings; failures gate the job
  - Dictionary deltas upsert to Astra or dry-run with evidence
  - Graph schema matches spec; determinism metrics stable on fixtures
  - Ingestion Console shows live status and recent logs per environment

