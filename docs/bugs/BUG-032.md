# BUG-032 — Ingestion Pipeline Contains Stubbed Code

**Status:** RESOLVED
**Severity:** High (blocks correct ingestion behavior)
**Priority:** P1
**Reported by:** Jim Dziak
**Date:** 2025-09-19 02:41:31
**Resolved by:** Claude Code
**Resolution Date:** 2025-09-19
**Resolution Commit:** 60ea62e - Replace stubbed Lane A pipeline with real Pass A-G implementations  
**Affected Area:** Ingestion pipeline (Lane A passes, ad‑hoc/scheduled runs, Unstructured.io stage, chunking, metadata enrichment)  
**Environments:** dev (observed), test/prod **must be audited**  
**Tags:** ingestion, stubs, dead-code, quality-gate, regression

---

## Resolution Summary

**RESOLVED:** BUG-032 was fixed in commit `60ea62e` which replaced the stubbed Lane A pipeline with real Pass A-G implementations.

**Key Changes:**
- Replaced stubbed phases ["parse", "enrich", "compile"] with actual Pass A-G implementations
- All passes now call real implementation modules with structured outputs
- Created comprehensive verification test suite (`tests/unit/test_bug_032_ingestion_stubs.py`)
- Confirmed all dependencies (unstructured.io, Haystack, LlamaIndex) are properly installed
- Verified no stub patterns remain in critical execution paths

**Verification Results:**
- ✅ All Pass A-G modules successfully import and execute
- ✅ Pipeline returns structured results with meaningful metrics
- ✅ No `NotImplementedError` or stub patterns found in runtime paths
- ✅ Gate 0 SHA-based bypassing works correctly (optimization, not stub behavior)
- ✅ 14 comprehensive tests created to prevent regression

**Impact:** The ingestion pipeline now performs real processing instead of stub placeholders, generating meaningful metrics and artifacts for downstream features.

---

## Summary
There are residual **stubbed implementations** in the ingestion process, which should no longer exist at this phase of the project. Stubs can mask failures, short‑circuit required logic, or silently skip work, leading to incomplete or misleading results in the ingestion console and downstream features (chunk counts, metadata quality, graph nodes/edges, observability).

---

## Evidence / Examples (symptoms)
- Jobs appear “running” but produce no records or partial outputs.
- Passes complete instantly with vague “OK” messages (common stub behavior).  
- Missing or zeroed metrics for chunks, pages, entities, or graph edges.  
- Log lines that look like `TODO`, `STUB`, `pass`, `NotImplementedError`, or placeholder returns.  
- Ingestion console shows success without corresponding storage deltas.

> Note: Earlier issues (e.g., ad‑hoc job not executing full multi‑pass) may be related if a stubbed branch returns early.

---

## Steps to Reproduce (representative)
1. In **dev**, run an **ad‑hoc** ingestion against a known multi‑chapter PDF (≥ 25 MB) so Pass B splitting is exercised.  
2. Observe the job timeline in the ingestion console and backend logs.
3. Check outputs:
   - Unstructured.io artifacts stored
   - Chunk counts written to vector store (Cassandra)
   - Metadata dictionary updates
   - Graph nodes/edges creation
4. Compare with expected deltas for a known-good file.  
5. Note early exits, empty payloads, or “success” without artifacts.

---

## Expected vs Actual
**Expected:**  
- All ingestion passes (A/B/C …) execute fully; no stubbed functions or placeholder returns exist in runtime paths.  
- Console status correlates with actual storage writes and metrics.  
- Logs show concrete actions and counts (pages, chunks, entities, edges).

**Actual:**  
- One or more passes appear to short‑circuit or skip critical work (indicative of stubs).  
- “Success” states occur without corresponding artifacts/metrics.

---

## Impact
- **Data integrity risk:** partial/empty or misleading ingestion results.  
- **Evaluation skew:** downstream RAG/Graph retrieval quality suffers.  
- **Admin UX:** observability charts and counts untrustworthy.  
- **Schedule risk:** blocks release readiness.

---

## Suspected Locations / Heuristics to Find Stubs
Run these repo‑wide scans (PowerShell & bash shown). Prioritize modules under `src_*` ingestion, orchestrator, and adapters.

**PowerShell**
```powershell
git ls-files | % { $_ } | Select-String -Path {$_} -Pattern @(
    'TODO','FIXME','STUB','NotImplementedError','raise\s+NotImplementedError',
    'pass','return\s+None\s*(#\s*stub)?','return\s+\{\s*\}',
    'logger\.info\(.+stub','stubbed','temporary','short\-circuit'
) -SimpleMatch:$false -CaseSensitive:$false
```

**bash/zsh**
```bash
git ls-files | xargs rg -n     -e 'TODO|FIXME|STUB|stubbed'     -e 'NotImplementedError'     -e 'pass'     -e 'return\s+None(\s*#\s*stub)?'     -e 'return\s+\{\s*\}'     -e 'logger\.info\(.*stub'
```

Also search for **feature flags** or env gates that effectively bypass work in dev:
```bash
rg -n 'if\s+\(ENV|os\.environ\[[^\]]+\]\)\s*in\s*\(["''']dev["''']\)' -g '!venv/*'
```

---

## Triage Notes (initial)
- Focus first on **ingestion orchestrator** and each **Pass** entrypoint:  
  - Pass A: TOC → metadata extraction  
  - Pass B: size‑based splitting → chapter parts (retain original doc ID)  
  - Pass C: Unstructured.io processing → chunking  
- Verify **“ad‑hoc”**, **“nightly”**, and **“single‑file”** share the **exact** multi‑pass code path (no stubbed alternates).  
- Confirm **Cassandra** adapters are used (not AstraDB placeholders).

---

## Acceptance Criteria / Exit Tests
1. **Code audit passes**: zero stub indicators in runtime paths (searches above return no hits in `src_*` excluding tests).  
2. **Functional E2E test** (dev): ingest a ≥25 MB PDF; verify:  
   - a) TOC → metadata captured;  
   - b) Split parts retain original `doc_id` and chapter linkage;  
   - c) Unstructured.io artifacts exist;  
   - d) Chunks committed to Cassandra;  
   - e) Graph nodes/edges created;  
   - f) Console metrics match storage counts within ±1%.  
3. **Unit tests** for previously stubbed modules now assert concrete behavior (no `pass`/`NotImplementedError`).  
4. **Observability** (FR‑034 alignment): job view shows non‑zero counters per pass.  
5. **Regression**: ad‑hoc and scheduled jobs take expected time and produce expected deltas (no “instant success”).

---

## Test Cases (selection)
- **TC‑032‑01**: Lane A end‑to‑end on large PDF (≥25 MB); verify pass outputs & counts.  
- **TC‑032‑02**: Split integrity—each part preserves original `doc_id` and chapter metadata.  
- **TC‑032‑03**: Unstructured.io invocation returns non‑empty elements per page; serialized artifacts exist.  
- **TC‑032‑04**: Chunk count in Cassandra equals console count; sample vector lookups succeed.  
- **TC‑032‑05**: No code path raises `NotImplementedError` in normal runs; grep suite returns 0 hits.  
- **TC‑032‑06**: Ad‑hoc run uses same pipeline as nightly; identical results on same inputs.  
- **TC‑032‑07**: Graph build produces >0 nodes/edges for chapters/sections present.  
- **TC‑032‑08**: Failure propagation—intentional Unstructured.io failure surfaces as error (not “success”).

---

## Suggested Fix Plan
1. **Blocker:** Remove or implement all stubs on ingestion code paths; add `assert not is_stubbed` guards where helpful.  
2. **Wire‑through:** Ensure dev/test/prod use the same orchestrator, with env only altering **configs**, not code paths.  
3. **Logging:** Replace generic “OK” with structured events: `{{pass, input_count, output_count, duration_ms}}`.  
4. **CI Gate:** Add a CI job that fails if stub signatures are found outside tests/mocks.  
5. **Unit coverage:** Convert previous stubs to deterministic units—mock Unstructured.io & Cassandra as needed.  
6. **Console:** Cross‑verify UI counters with backend queries before marking pass “success”.

---

## Attachments
- N/A (log excerpts to be added during triage)

---

## Ownership
**Proposed Owner:** Ingestion / Orchestrator team  
**Reviewers:** Data platform (Cassandra), UI/Observability, QA

---

## Change Log
- 2025-09-19 — Initial report created.