# BUG-025 â€” Log Management page fails to load (SyntaxError in admin JS)

**Report Date:** 2025-09-17  
**Reported by:** Jim Dziak / TTRPG Center QA  
**Environment:** Development (observed on admin UI at https://4334355b0849.ngrok-free.app/admin/logs)

## Summary
When opening the Log Management page the log table never loads and the page UI shows placeholder values ("--" and "Loading log data..."). The browser console shows a JavaScript `SyntaxError` caused by an unescaped line break in a string literal, which prevents the client-side script from executing and populating the page.

## Affected area
- Admin â†’ Log Management (`/admin/logs`) â€” the ingestion logs table and log viewer never populate. The page displays "Loading log data..." and "Static Last updated: --".

## Evidence (console messages observed)
- `Uncaught SyntaxError: "" string literal contains an unescaped line break  admin:1105:161`
- `WebSocket connected  admin:518:25` (connection opens but page logic fails afterwards)
- Page content shows placeholders and loading text (observed on the page HTML: "Loading log data..." and "Static Last updated: --").

## Reproduction Steps
1. Start the application (dev environment) and ensure admin is accessible via the current ngrok URL.  
2. In a browser, navigate to: `https://4334355b0849.ngrok-free.app/admin/logs`.  
3. Open browser Developer Tools â†’ Console.  
4. Observe console errors: a `SyntaxError` referencing `admin:1105:161` reporting an unescaped line break in a string literal.  
5. Observe the page: the log table shows "Loading log data..." and summary fields show `--` instead of counts.

## Actual Result
- The logs list and log viewer remain empty/unpopulated.
- Filtering controls appear but have no effect because client-side JS failed to run.
- Console shows a `SyntaxError` (unescaped line break) preventing further JS execution.

## Expected Result
- The page should load ingestion log entries from the backend and populate:
  - Log Management Info: Total Logs, Running Jobs, Total Size
  - Ingestion Logs table: rows with Job ID, Job Type, Status, PID, Start/End times, Duration, File Size, Source(s), Environment, Actions
  - Log Viewer should allow selecting and downloading a log.

## Suggested Root Cause
A JavaScript string literal in `admin` bundle (or inline admin script/template) contains an unescaped raw newline, causing the parser to throw a `SyntaxError` at parse-time. Common scenarios:
- A server-side template injects a multi-line string into a quoted JS string without escaping newlines.
- An accidental concatenation or missing template literal backticks where multiline text was intended.
- A build step (minifier/templating) introduced a malformed string.

The console points to `admin:1105:161` â€” this indicates the error location in the rendered admin script (line ~1105).

## Suggested Fixes / Remediation
1. **Locate the offending code:**
   - Open the served `admin` JavaScript (or the inline script in the admin HTML). Search around the referenced line (â‰ˆ1105) for quoted string literals containing newline characters.
   - Example bad pattern: `var s = "line1
line2";` â€” should be escaped or use template literals.
2. **Fix string quoting:**
   - Replace broken double/single-quoted multi-line strings with template literals (backticks) or escape newline characters (`\n`).
3. **Add a lint/build check:**
   - Add ESLint rule to fail builds on multiline string literal errors or unescaped newlines.
   - Add automated smoke test: load `/admin/logs` headlessly and assert no console `SyntaxError`.
4. **Improve server-side templating:**
   - When injecting server-side content into JS, serialize/escape strings correctly (use JSON.stringify or templating escape helpers).
5. **Add runtime guard:**
   - Wrap critical admin initialization in a `try/catch` and report parse/init errors to server logs to aid debugging without breaking the entire page.
6. **Deploy fix & verify:**
   - Rebuild the admin bundle, deploy to dev, clear browser cache (to avoid cached broken JS), and test `/admin/logs` loads successfully.

## Test Cases
- **TC-1: Page loads without JS parse errors**
  - Steps: Navigate to `/admin/logs` in dev; open console; assert no `SyntaxError` messages.
  - Expected: No parse-time `SyntaxError`.

- **TC-2: Logs populate**
  - Steps: With at least one ingestion log present, open `/admin/logs`; confirm table rows appear and summary counters update.
  - Expected: Table rows displayed; "Total Logs" > 0; "Running Jobs" accurate.

- **TC-3: Log Viewer works**
  - Steps: Click a log row "eye" action; confirm Log Viewer populates and Download works.
  - Expected: Viewer shows log lines and Download button returns file content.

- **TC-4: Filter / Export works**
  - Steps: Use filters (Environment, Status, Job Type) and click Export All.
  - Expected: Results filtered; export returns CSV of filtered logs.

## Severity & Priority
- **Severity:** High â€” admin Log Management is unusable in current dev environment.
- **Priority:** P1 â€” prevents debugging and monitoring of ingestion jobs.

## Attachments / References
- Page snapshot (HTML snippet shows "Loading log data..." and "Static Last updated: --").  
- Console error: `Uncaught SyntaxError: "" string literal contains an unescaped line break  admin:1105:161`.

---

### Notes / Next steps for developer
- Inspect the built admin JS bundle (or the template that generates `admin` script). Grep for `"
` or raw newline patterns.
- If using template injection of server content into JS, convert injection to `JSON.stringify(variable)` and parse on client.
- After fix, instruct QA to verify on Chrome/Firefox and to clear cache or open in incognito to avoid cached broken JS files.


## Resolution (2025-09-17)
- Root Cause: Inline `onclick="viewLog(...)"` handlers embedded raw log file paths. Paths containing escape sequences (for example `\n`) produced actual line breaks inside the generated script, triggering a `SyntaxError` before the Log Management page initialized. The inline handler also lacked HTML escaping, magnifying the issue on Windows-style paths.
- Fix: Switched the Log Management table to data attributes driven by delegated click handlers, added encoding/escaping helpers for table content, and removed all inline JavaScript handlers to guarantee safe string construction.
- Tests: `docker compose -f docker-compose.dev.yml exec app-dev /opt/venv/bin/python …` smoke check verifying the rendered page no longer contains `onclick="viewLog(`), plus new functional test `tests/functional/test_admin_logs_page.py`.

