# BUG-029 ??? Deployment & UI Cassandra/Astra issues
**Reported:** 2025-09-18 17:10:17 (America/Chicago)  
**Reporter:** Project Admin (via ChatGPT)  
**Environments Affected:** DEV primarily; TEST/PROD impact likely where configs are shared  
**Category:** Bug Bundle (3 related defects)  
**Status:** Open  
**Priority:** High (blocks clear observability and correct configuration)

---

## Summary
Three defects observed during local/containerized development:

1. **[BUG-029-A] Cassandra container not visible in Docker Desktop** (possibly mislabeled or not starting).
2. **[BUG-029-B] OpenAI API key not propagating to DEV during deployment** (env var missing/blank within running containers).
3. **[BUG-029-C] Codebase and UI still reference ???AstraDB???; must be updated to ???Cassandra???** (terminology/config drift).

---

## System Context
- Containerized DEV environment (Docker Compose) with service lanes (A/B/C) and ingestion pipeline.
- Vector store target: **Cassandra** (local container) replacing AstraDB for DEV per FR-031.
- OpenAI GPT???5 used for all non-embedding LLM calls; key provided via environment secrets.

---

## Affected Components
- **Docker**: compose manifests, service names, healthchecks.
- **Config**: `.env`, env var templates, compose `environment:` blocks, entrypoint scripts.
- **App Code**: vector client factories, DI wiring, feature flags.
- **UI**: panels/labels that display ???AstraDB??? health/status.
- **CI/CD**: dev deploy scripts that inject environment variables.

---

## Detailed Defects

### BUG-029-A ??? Cassandra image/service not visible in Docker Desktop
**Symptom:** No ???cassandra??? container appears in Docker Desktop after bringing up DEV; ingestion and services that depend on the vector store fail or hang.

**Severity:** High (blocks local vector operations).

**Hypotheses:**
- Service name or `container_name` is **mislabeled** (e.g., ???vector-db???, ???db-cass???, or legacy ???astradb???).
- Compose profile/condition excludes Cassandra in DEV.
- Image pull or healthcheck failing; container exits immediately.
- Port collisions (9042/9160) or volume permission issue.
- Docker Desktop UI shows ???Stopped??? with short-lived exits due to JVM/memory limits.

**How to Reproduce**
1. `docker compose -f env/dev/docker-compose.yml up -d`  
2. Open Docker Desktop ??? Containers.
3. Observe: no service clearly labeled ???cassandra???; dependent services report connection failures.

**Expected vs Actual**
- **Expected:** A running container named and labeled as Cassandra (e.g., `cassandra`), healthy and reachable on 9042.
- **Actual:** Not visible or mislabeled; or present but repeatedly restarting/exiting.

**Diagnostics**
- `docker compose ps`
- `docker logs <cassandra-like-name>`
- `docker inspect <id> | jq '.[0].Name, .[0].Config.Image, .[0].Config.Env'`
- `docker exec -it <id> nodetool status` (when running)
- Check ports: `netstat -ano | findstr ":9042"` (Windows) / `lsof -i :9042` (Unix)

**Proposed Fix**
- Standardize the service to `cassandra`:
  - `image: cassandra:5` (or approved version)
  - `container_name: cassandra`
  - `ports: ["9042:9042"]`
  - `healthcheck:` use `cqlsh -e "SHOW VERSION"` or `nodetool status`
- Ensure compose profile includes Cassandra for DEV.
- Increase container heap/memory if OOM.
- Add explicit label: `com.ttrpg.role=vector-store` for UI discovery.

**Acceptance Criteria**
- `docker compose ps` shows `cassandra` **healthy**.
- Docker Desktop lists `cassandra` clearly.
- `cqlsh localhost 9042` connects from an app container.
- Ingestion can create/read vector tables without retries >1.

---

### BUG-029-B ??? OpenAI API key not propagated to DEV containers
**Symptom:** Within running app containers, `OPENAI_API_KEY` is empty or undefined; LLM calls fail.

**Severity:** High (blocks LLM-dependent features).

**Likely Root Causes**
- Missing var in `.env` or compose `environment:` blocks.
- CI/dev deploy script not exporting `OPENAI_API_KEY` prior to `docker compose up`.
- Name mismatch (e.g., `OPENAI_APIKEY` vs `OPENAI_API_KEY`, `OPENAI__API_KEY`).
- Using compose `env_file:` but referencing the wrong path.
- Secrets injected in shell but not passed to containers.

**How to Reproduce**
1. Set `OPENAI_API_KEY` in host environment or `.env`.
2. `docker compose -f env/dev/docker-compose.yml up -d`
3. `docker exec -it <app> /bin/sh -lc 'echo $OPENAI_API_KEY | wc -c'`
   - Returns `0` ??? not propagated.

**Expected vs Actual**
- **Expected:** App containers see `OPENAI_API_KEY` and SDK calls succeed.
- **Actual:** Key missing; runtime errors/timeouts; 401/403 from OpenAI.

**Proposed Fix**
- Ensure *one* source of truth:
  - `.env` (DEV only): `OPENAI_API_KEY=...`
  - `env/dev/docker-compose.yml`:
    ```yaml
    services:
      app:
        env_file: ["../../.env"]
        environment:
          - OPENAI_API_KEY=${OPENAI_API_KEY}
    ```
- Verify scripts export before compose:
  - PowerShell: `$env:OPENAI_API_KEY = (Get-Content .env | ...)`
  - Bash: `export $(grep -v '^#' .env | xargs)`
- Add a startup assert: on boot, log a redacted key length (e.g., `len=51`).

**Acceptance Criteria**
- `docker exec <app> printenv OPENAI_API_KEY` returns non-empty (masked in app logs).
- Sample call to `models.list()` or a trivial chat completes in DEV.
- CI/dev deploy emits a preflight check: ???OPENAI_API_KEY detected (len>20).???

**Test Snippet (pseudo)**
```python
import os, sys
key = os.getenv("OPENAI_API_KEY")
assert key and len(key) > 20, "OPENAI_API_KEY not propagated"
```

---

### BUG-029-C ??? Replace ???AstraDB??? terminology and config with ???Cassandra???
**Symptom:** UI labels and parts of the code still say ???AstraDB??? after the decision to use Cassandra locally; user-facing panels mislead operators, and config paths may be stale.

**Severity:** Medium-High (UX + possible misconfiguration).

**Scope**
- UI: dashboard tiles, tooltips, health widgets, menu items.
- Backend: vector client selection, env var names, logs/metrics.
- Docs: READMEs, comments, sample `.env` templates, screenshots.

**Rename/Refactor Plan**
- **Terminology:** ???AstraDB??? ??? ???Cassandra (DEV)??? in UI.  
  For PROD/Test using AstraDB in the future, render environment-specific labels dynamically.
- **Env Vars:** 
  - Replace/alias `ASTRA_*` with `CASSANDRA_*` in DEV.
  - Keep backward-compatible reading with deprecation warning:
    ```python
    cass_host = os.getenv("CASSANDRA_HOST") or os.getenv("ASTRA_HOST")
    if os.getenv("ASTRA_HOST"):
        logger.warn("ASTRA_* env vars are deprecated; use CASSANDRA_* in DEV")
    ```
- **Configuration keys (examples):**
  - `CASSANDRA_HOST`, `CASSANDRA_PORT=9042`, `CASSANDRA_KEYSPACE=ttrpg`
  - `CASSANDRA_USER`, `CASSANDRA_PASSWORD` (if auth enabled)
- **UI Strings:** ???Vector Store Health ??? Cassandra (DEV)???; ???Chunks in Cassandra by Source???.

**Search & Replace Guidance**
Use *surgical* edits and review diffs:
```bash
# Inventory references
git grep -nE "(?i)astradb|astra_db|astra-db|Astra DB|AstraDB"

# Candidate replacements (verify per file)
# Example replacements (bash):
#   AstraDB ??? Cassandra
#   Astra DB ??? Cassandra
#   astra ??? cassandra (ONLY where referring to vector store)
```

**Acceptance Criteria**
- No visible ???AstraDB??? strings in DEV UI.
- Health panel queries Cassandra for counts and status.
- Backend selects Cassandra client in DEV without feature flags.
- README and .env.sample reflect Cassandra for local runs.

**Verification Tests**
- UI e2e: dashboard shows ???Cassandra (DEV)??? with non-zero chunk counts.
- API: `/health/vector` returns `backend: cassandra`.
- Ingestion: creates/reads vectors without fallbacks to Astra adapters.

---

## Cross-Cutting Test Cases (for the bundle)
1. **Smoke: Containers come up healthy** ??? Cassandra shows `healthy`, app connects.
2. **Secrets: OPENAI_API_KEY visible in-app** ??? app logs preflight, trivial model call succeeds.
3. **UI Copy & Data Wiring:** Dashboard text uses ???Cassandra (DEV)???; chunk counts reflect Cassandra keyspace.
4. **Regression:** If TEST/PROD still use AstraDB, environment toggles correctly name & target that backend without DEV leakage.
5. **Docs:** Quickstart shows correct steps for DEV Cassandra and how to provide OpenAI key.

---

## Exit Criteria
- All acceptance criteria per defect met.
- PR includes: compose fix, env propagation fix, UI/strings refactor, docs updates.
- Screenshots: Docker Desktop with `cassandra` healthy; UI panel updated.
- Automated checks:
  - Unit test: env key presence assertion.
  - Integration test: vector client connects to Cassandra and reports keyspace.
  - UI test: selector text contains ???Cassandra (DEV)???.

---

## Attachments / Evidence (to be added during triage)
- Docker logs from Cassandra start
- Screenshot of Docker Desktop (pre/post fix)
- App logs showing preflight secret detection
- UI screenshot of updated labels

---

## Owner / Routing
- **Infra/DevOps:** Compose & secrets propagation
- **Backend:** Vector client wiring
- **Frontend:** UI copy & health panels
- **Docs:** README & .env samples

## Resolution Status ? 2025-09-18
- DEV docker-compose now provisions the `cassandra` service with a healthcheck and mounts `env/dev/config/.env` so secrets propagate into containers.
- `OPENAI_API_KEY` and related configuration load automatically via the shared env file; init scripts seed Cassandra-focused entries instead of AstraDB defaults.
- Admin APIs, health checks, and UI copy now reference the Cassandra vector store; ingestion health uses the active vector backend via the loader rather than Astra-specific code.
- Documentation and generated environment files warn about legacy Astra settings while steering DEV to Cassandra.

