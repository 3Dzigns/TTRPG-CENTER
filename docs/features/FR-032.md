# FR-032 – Data Strategy, Environment Isolation, Observability, and Consistency Fixes

## Summary
Define and implement a unified data strategy for TTRPG Center that covers content lanes, storage engines, environment separation (DEV/TEST/PROD), observability, and corrections found in recent reviews. This feature combines technical design decisions (data pipeline, storage, HGRN pass) with urgent fixes (test harness stability, stub removal, API alignment).

---

## Context & Rationale
- **Content Lanes**: Lane A (publisher-licensed), Lane B (homebrew tied to a game), Lane C (marketplace export).
- **Storage Engines**: Cassandra (vectors), MongoDB (dictionary), Neo4j (graph), Redis (cache), Postgres (auth/long-term memory).
- **Ingestion**: Expanded to seven passes with HGRN health check at the end.
- **Environment Separation**: Each environment runs an isolated Docker stack (Phase-0 principle). Admin UI must be environment scoped.
- **Observability**: Must show “stub vs real” in traces and Admin UI.
- **Consistency Review Findings**:
  1. **Stub LLM** still used in orchestration; must be replaced with real GPT-5 (with fallbacks) in DEV/TEST/PROD.
  2. **Failing test harness**: `pytest` fails due to Cassandra driver incompatibility with Python 3.12. Need driver alignment or alternate configuration.
  3. **API mismatch**: Documentation references `/rag/classify` and `/rag/retrieve`, but the service exposes only `/rag/ping` and `/rag/ask`. Code and docs must align.
  4. **Onboarding**: Contributor docs do not mention installing the Cassandra driver; new devs cannot run tests without extra steps.
  5. **Docs readability**: Replacement glyphs in plain-text viewers break contributor onboarding.

---

## Epics & User Stories

### Epic E32.1 – Lane-Based Content Management
- **US-3201**: As a Publisher, I want Lane A isolated from Lane B/C so licensing is respected.
- **US-3202**: As a GM, I want to upload Lane B homebrew scoped to my game.
- **US-3203**: As a Designer, I want to package Lane C modules for marketplace export.

### Epic E32.2 – Storage Engine Integration
- **US-3204**: As a Developer, I want Cassandra, MongoDB, Neo4j, Redis, and Postgres in isolated containers per environment.
- **US-3205**: As an Operator, I want traces that show which backends were used.

### Epic E32.3 – Ingestion with HGRN Health Pass
- **US-3206**: As a Data Steward, I want seven passes with HGRN at the end, blocking unhealthy jobs.

### Epic E32.4 – Environment-Scoped Admin UI
- **US-3207**: As an Admin, I want the Admin UI isolated per environment.
- **US-3208**: As a Tester, I want DEV Admin changes not to affect TEST/PROD.

### Epic E32.5 – Observability & Stub vs Real Flags
- **US-3209**: As a Developer, I want logs and UI to show whether a response used a stub or a real model.
- **US-3210**: As an Admin, I want real-time traces per query with lane and storage indicators.

### Epic E32.6 – Consistency Review Fixes
- **US-3211**: As a Developer, I want the orchestrator to use GPT-5 (with fallbacks) instead of a stub LLM so tests are meaningful.
- **US-3212**: As a Contributor, I want Cassandra driver installation documented or stubbed so `pytest` succeeds.
- **US-3213**: As a User, I want API endpoints consistent between docs and service (`/rag/classify`, `/rag/retrieve`, `/rag/ask`).
- **US-3214**: As a Maintainer, I want contributor guides updated with Cassandra driver instructions.
- **US-3215**: As a Reader, I want plain-text docs to render without replacement glyphs.

---

## Test Cases

### Unit
- Lane tagging attaches the correct `lane_id`.
- Storage adapters connect only to the local environment.
- HGRN pass rejects malformed graph/dictionary entries.
- Trace builder includes the stub vs real indicator.
- Documentation schema validates without glyph issues.

### Functional
- Ingest a Lane A licensed book and ensure retrieval returns licensed chunks only.
- GM uploads Lane B content and it appears only in their namespace.
- Lane C export produces a marketplace package.
- DEV Admin cache toggle does not affect TEST/PROD.
- Stubbed LLM replaced with GPT-5; fallback to GPT-4 verified.
- `pytest` runs green with Cassandra driver installed.
- API docs updated; curl `/rag/classify` and `/rag/retrieve` return HTTP 200.
- Contributor runs onboarding, installs the driver, and tests succeed.

### Regression
- Golden ingestion fixtures remain stable across seven passes.
- Lane tagging schema unchanged.
- Cache isolation verified.
- Regression tests pass in CI with the Cassandra driver.

### Security
- Lane A data cannot leak to unauthorized users.
- Redis cache keys are namespaced per environment/tenant.
- Neo4j queries are scoped by environment.
- Admin UI requires authentication.
- Documentation sanitization prevents injection when replacing glyphs.

---

## Definition of Done
- Lane model (A/B/C) enforced across ingestion and retrieval.
- Storage engines wired per environment and health-checked in CI.
- Ingestion expanded to seven passes with HGRN validation.
- Admin UI isolated per environment.
- Observability improved with stub vs real flags.
- Stub LLM removed; GPT-5 (with GPT-4 fallback) wired into orchestration.
- Cassandra driver documented and tests green under Python 3.12.
- API endpoints aligned with documentation.
- Contributor docs include Cassandra driver installation steps.
- Docs render without replacement glyphs.
- Unit, functional, regression, and security tests green in CI.
